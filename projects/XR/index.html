<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Haber-Bosch Process WebAR Lab | Chemical Engineering</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0d1b2a">
    <meta name="description" content="Interactive WebAR simulation of the Haber-Bosch ammonia synthesis process for chemical engineering education">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Using specific Three.js version known to work well with iOS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- MindAR with iOS compatibility fixes -->
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-three.prod.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none;
            user-select: none;
        }

        :root {
            --primary-blue: #0d1b2a;
            --secondary-blue: #1b263b;
            --accent-blue: #415a77;
            --light-blue: #778da9;
            --highlight: #e0e1dd;
            --reactor-color: #5a6268;
            --n2-color: #4d8ac8;
            --h2-color: #2ecc71;
            --nh3-color: #e67e22;
            --recycle-color: #95a5a6;
            --danger: #e74c3c;
            --success: #2ecc71;
            --warning: #f39c12;
            --shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, var(--primary-blue), var(--secondary-blue));
            color: var(--highlight);
            min-height: 100vh;
            overflow-x: hidden;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Enhanced Loading Screen */
        #loadingScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--primary-blue);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.5s ease;
        }

        .loader {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top-color: var(--light-blue);
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* iOS Permission Prompt */
        #permissionPrompt {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(13, 27, 42, 0.95);
            backdrop-filter: blur(10px);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 999;
            padding: 30px;
            text-align: center;
        }

        .permission-content {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 40px 30px;
            max-width: 500px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(20px);
        }

        .permission-content h2 {
            font-size: 1.8rem;
            margin-bottom: 20px;
            color: var(--highlight);
        }

        .permission-content p {
            margin-bottom: 25px;
            color: var(--light-blue);
            line-height: 1.6;
        }

        .permission-icon {
            font-size: 3rem;
            color: var(--accent-blue);
            margin-bottom: 20px;
        }

        .permission-steps {
            text-align: left;
            margin: 25px 0;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            padding: 20px;
        }

        .permission-steps ol {
            padding-left: 20px;
            margin: 15px 0;
        }

        .permission-steps li {
            margin-bottom: 12px;
            color: var(--light-blue);
        }

        .permission-btn {
            background: linear-gradient(135deg, var(--accent-blue), var(--light-blue));
            color: white;
            border: none;
            border-radius: 12px;
            padding: 16px 30px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(65, 90, 119, 0.3);
        }

        .permission-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(65, 90, 119, 0.4);
        }

        /* Instruction View */
        #instructionView {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 40px 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 2.8rem;
            font-weight: 700;
            margin-bottom: 10px;
            background: linear-gradient(90deg, var(--light-blue), var(--highlight));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .header .subtitle {
            font-size: 1.2rem;
            color: var(--light-blue);
            max-width: 600px;
            margin: 0 auto;
        }

        .ios-warning {
            background: rgba(243, 156, 18, 0.1);
            border: 1px solid rgba(243, 156, 18, 0.3);
            border-radius: 12px;
            padding: 15px;
            margin: 20px auto;
            max-width: 600px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .ios-warning i {
            color: var(--warning);
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        /* Rest of your existing CSS remains the same */
        .content-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            margin-bottom: 40px;
        }

        @media (max-width: 900px) {
            .content-grid {
                grid-template-columns: 1fr;
            }
        }

        .target-section, .instructions-section {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .target-section h2, .instructions-section h2 {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: var(--highlight);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .target-image-container {
            background: white;
            border-radius: 12px;
            padding: 25px;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }

        .target-image {
            width: 280px;
            height: 280px;
            background: linear-gradient(45deg, #0d1b2a 25%, #1b263b 25%, #1b263b 50%, #0d1b2a 50%, #0d1b2a 75%, #1b263b 75%);
            background-size: 40px 40px;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow: hidden;
        }

        .target-image::before {
            content: '';
            position: absolute;
            width: 180px;
            height: 180px;
            border-radius: 50%;
            background: white;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.1);
        }

        .target-image::after {
            content: 'N₂ + H₂';
            position: absolute;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            font-size: 1.8rem;
            color: var(--primary-blue);
            z-index: 2;
        }

        .target-shapes {
            position: absolute;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        .shape {
            position: absolute;
            background: var(--primary-blue);
        }

        .shape.triangle {
            width: 0;
            height: 0;
            border-left: 30px solid transparent;
            border-right: 30px solid transparent;
            border-bottom: 50px solid var(--primary-blue);
            top: 40px;
            left: 50%;
            transform: translateX(-50%);
        }

        .shape.square {
            width: 50px;
            height: 50px;
            right: 40px;
            top: 50%;
            transform: translateY(-50%);
        }

        .shape.hexagon {
            width: 50px;
            height: 50px;
            background: var(--primary-blue);
            clip-path: polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%);
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
        }

        .shape.circle {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            left: 40px;
            top: 50%;
            transform: translateY(-50%);
        }

        .instructions-list {
            list-style: none;
        }

        .instructions-list li {
            margin-bottom: 20px;
            padding-left: 40px;
            position: relative;
        }

        .instructions-list li i {
            position: absolute;
            left: 0;
            top: 0;
            width: 30px;
            height: 30px;
            background: var(--accent-blue);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--highlight);
        }

        .process-overview {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 40px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .process-overview h2 {
            font-size: 1.5rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .process-steps {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .process-step {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: transform 0.3s ease, background 0.3s ease;
        }

        .process-step:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.12);
        }

        .step-number {
            display: inline-block;
            width: 36px;
            height: 36px;
            background: var(--accent-blue);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            margin-bottom: 12px;
        }

        /* AR Container */
        #arContainer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            display: none;
            background: #000;
        }

        #arScene {
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
        }

        .ar-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 20;
        }

        /* Control Panel */
        #controlPanel {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(13, 27, 42, 0.85);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            pointer-events: all;
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: var(--shadow);
            z-index: 30;
        }

        .control-btn {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--highlight);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            cursor: pointer;
            transition: all 0.2s ease;
            -webkit-tap-highlight-color: transparent;
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }

        .control-btn.active {
            background: var(--accent-blue);
            color: white;
        }

        .step-slider-container {
            display: flex;
            align-items: center;
            gap: 15px;
            min-width: 250px;
        }

        .step-slider-container span {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 500;
            min-width: 120px;
            font-size: 0.95rem;
        }

        .slider {
            flex-grow: 1;
            height: 8px;
            -webkit-appearance: none;
            appearance: none;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            outline: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: var(--light-blue);
            cursor: pointer;
            border: 3px solid var(--primary-blue);
        }

        /* Info Card */
        .info-card {
            position: absolute;
            top: 30px;
            right: 30px;
            background: rgba(13, 27, 42, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 25px;
            width: 320px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: var(--shadow);
            transform: translateY(-20px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
            pointer-events: all;
            z-index: 30;
        }

        .info-card.active {
            transform: translateY(0);
            opacity: 1;
        }

        .info-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .info-card-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--highlight);
        }

        .close-card {
            background: none;
            border: none;
            color: var(--light-blue);
            font-size: 1.2rem;
            cursor: pointer;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s ease;
            -webkit-tap-highlight-color: transparent;
        }

        .close-card:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .info-card-content {
            margin-bottom: 20px;
        }

        .parameter-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin: 15px 0;
        }

        .parameter {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 12px;
        }

        .parameter-label {
            font-size: 0.85rem;
            color: var(--light-blue);
            margin-bottom: 5px;
        }

        .parameter-value {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 500;
            font-size: 1rem;
            color: var(--highlight);
        }

        .chemical-equation {
            background: rgba(65, 90, 119, 0.2);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.2rem;
            margin: 15px 0;
            border: 1px solid rgba(65, 90, 119, 0.4);
        }

        .info-audio-controls {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 15px;
        }

        .audio-btn {
            padding: 10px 18px;
            border-radius: 8px;
            background: var(--accent-blue);
            color: white;
            border: none;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.2s ease;
            -webkit-tap-highlight-color: transparent;
        }

        .audio-btn:hover {
            background: #4a6b96;
        }

        /* Process Visualization */
        #processVisualization {
            position: absolute;
            top: 30px;
            left: 30px;
            background: rgba(13, 27, 42, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 20px;
            width: 220px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: var(--shadow);
            z-index: 30;
            pointer-events: all;
        }

        .visualization-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .process-flow {
            height: 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            margin: 20px 0;
            position: relative;
            overflow: hidden;
        }

        .flow-progress {
            position: absolute;
            height: 100%;
            background: linear-gradient(90deg, var(--n2-color), var(--h2-color), var(--nh3-color));
            border-radius: 6px;
            width: 0%;
            transition: width 0.5s ease;
        }

        .flow-markers {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .flow-marker {
            position: absolute;
            width: 20px;
            height: 20px;
            background: var(--primary-blue);
            border-radius: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            border: 3px solid rgba(255, 255, 255, 0.3);
        }

        .flow-marker.active {
            border-color: var(--highlight);
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        .flow-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
            font-size: 0.8rem;
            color: var(--light-blue);
        }

        /* Start Button */
        .start-ar-btn {
            background: linear-gradient(135deg, var(--accent-blue), var(--light-blue));
            color: white;
            border: none;
            border-radius: 12px;
            padding: 18px 40px;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin: 30px auto 0;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(65, 90, 119, 0.3);
            max-width: 300px;
            -webkit-tap-highlight-color: transparent;
        }

        .start-ar-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(65, 90, 119, 0.4);
        }

        .start-ar-btn:active {
            transform: translateY(0);
        }

        /* Footer */
        .footer {
            text-align: center;
            margin-top: 50px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--light-blue);
            font-size: 0.9rem;
        }

        .compatibility-warning {
            background: rgba(231, 76, 60, 0.1);
            border: 1px solid rgba(231, 76, 60, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 20px auto;
            max-width: 600px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* iOS specific fixes */
        @supports (-webkit-touch-callout: none) {
            .start-ar-btn, .control-btn, .audio-btn {
                cursor: default;
            }
            
            .info-card, #controlPanel, #processVisualization {
                -webkit-backdrop-filter: blur(10px);
                backdrop-filter: blur(10px);
            }
            
            /* Prevent zoom on input */
            input, select, textarea {
                font-size: 16px !important;
            }
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .content-grid {
                gap: 20px;
            }
            
            .target-section, .instructions-section {
                padding: 20px;
            }
            
            .target-image {
                width: 220px;
                height: 220px;
            }
            
            #controlPanel {
                bottom: 20px;
                padding: 15px;
                flex-wrap: wrap;
                justify-content: center;
                width: 90%;
            }
            
            .step-slider-container {
                order: -1;
                width: 100%;
                margin-bottom: 10px;
            }
            
            .info-card {
                top: 20px;
                right: 20px;
                left: 20px;
                width: auto;
            }
            
            #processVisualization {
                top: 20px;
                left: 20px;
                width: calc(100% - 40px);
            }
            
            /* iOS safe areas */
            .control-btn, #controlPanel {
                margin-bottom: env(safe-area-inset-bottom, 0px);
            }
            
            .info-card, #processVisualization {
                margin-top: env(safe-area-inset-top, 0px);
            }
        }

        /* Animation for particles */
        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(180deg); }
        }

        @keyframes flow {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(1000%); }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen">
        <div class="loader"></div>
        <h2 style="margin-top: 20px; color: var(--light-blue);">Initializing Haber-Bosch AR Lab</h2>
        <p id="loadingText" style="margin-top: 10px; color: var(--light-blue); text-align: center; max-width: 300px;">
            Loading 3D models and AR engine...
        </p>
    </div>

    <!-- iOS Permission Prompt -->
    <div id="permissionPrompt">
        <div class="permission-content">
            <div class="permission-icon">
                <i class="fas fa-camera"></i>
            </div>
            <h2>Camera Access Required</h2>
            <p>To use the AR experience, we need access to your camera. Please follow these steps:</p>
            
            <div class="permission-steps">
                <p><strong>iOS Safari Instructions:</strong></p>
                <ol>
                    <li>Tap "Allow Camera" below</li>
                    <li>If prompted, tap "Allow" in the permission dialog</li>
                    <li>If you previously denied access, go to Settings > Safari > Camera and set to "Allow"</li>
                    <li>Refresh the page and try again</li>
                </ol>
            </div>
            
            <button id="requestPermission" class="permission-btn">
                <i class="fas fa-camera"></i> Allow Camera Access
            </button>
            <button id="skipPermission" class="permission-btn" style="background: rgba(255,255,255,0.1); margin-left: 10px;">
                <i class="fas fa-eye-slash"></i> View Without AR
            </button>
        </div>
    </div>

    <!-- Instruction View -->
    <div id="instructionView">
        <div class="container">
            <header class="header">
                <h1>Haber-Bosch Process AR Lab</h1>
                <p class="subtitle">Interactive WebAR simulation for chemical engineering education. Visualize and interact with the ammonia synthesis process in augmented reality.</p>
                
                <!-- iOS Specific Warning -->
                <div class="ios-warning" id="iosWarning" style="display: none;">
                    <i class="fas fa-mobile-alt"></i>
                    <div>
                        <strong>iPhone/iPad Users:</strong> For best AR experience, use Safari and ensure camera permissions are enabled. If AR doesn't start, tap the "View Without AR" option.
                    </div>
                </div>
            </header>
            
            <div class="content-grid">
                <section class="target-section">
                    <h2><i class="fas fa-bullseye"></i> AR Target Image</h2>
                    <div class="target-image-container">
                        <div class="target-image">
                            <div class="target-shapes">
                                <div class="shape triangle"></div>
                                <div class="shape square"></div>
                                <div class="shape hexagon"></div>
                                <div class="shape circle"></div>
                            </div>
                        </div>
                        <p style="margin-top: 20px; color: var(--light-blue); text-align: center;">
                            Point your camera at this target image to activate the AR experience
                        </p>
                    </div>
                    
                    <div class="compatibility-warning">
                        <i class="fas fa-exclamation-triangle" style="color: var(--warning);"></i>
                        <div>
                            <strong>Compatibility Note:</strong> For best AR results, use Safari on iOS or Chrome on Android. Ensure good lighting conditions.
                        </div>
                    </div>
                </section>
                
                <section class="instructions-section">
                    <h2><i class="fas fa-graduation-cap"></i> How to Use</h2>
                    <ul class="instructions-list">
                        <li>
                            <i class="fas fa-camera"></i>
                            <strong>Allow Camera Access</strong><br>
                            When prompted, grant permission to use your device's camera.
                        </li>
                        <li>
                            <i class="fas fa-vector-square"></i>
                            <strong>Scan the Target Image</strong><br>
                            Point your camera at the target image shown on the left.
                        </li>
                        <li>
                            <i class="fas fa-hand-pointer"></i>
                            <strong>Interact with 3D Model</strong><br>
                            Tap on different components to learn about their function.
                        </li>
                        <li>
                            <i class="fas fa-volume-up"></i>
                            <strong>Listen to Explanations</strong><br>
                            Audio explanations will play for each component you select.
                        </li>
                    </ul>
                </section>
            </div>
            
            <section class="process-overview">
                <h2><i class="fas fa-industry"></i> Process Overview</h2>
                <div class="process-steps">
                    <div class="process-step">
                        <div class="step-number">1</div>
                        <h3>Nitrogen Extraction</h3>
                        <p>N₂ from air via cryogenic distillation</p>
                    </div>
                    <div class="process-step">
                        <div class="step-number">2</div>
                        <h3>Hydrogen Production</h3>
                        <p>H₂ from natural gas via steam reforming</p>
                    </div>
                    <div class="process-step">
                        <div class="step-number">3</div>
                        <h3>Compression</h3>
                        <p>Gases compressed to 150-300 atm</p>
                    </div>
                    <div class="process-step">
                        <div class="step-number">4</div>
                        <h3>Catalytic Reaction</h3>
                        <p>N₂ + 3H₂ → 2NH₃ at 400-500°C</p>
                    </div>
                    <div class="process-step">
                        <div class="step-number">5</div>
                        <h3>Separation & Recycling</h3>
                        <p>NH₃ separated, unreacted gases recycled</p>
                    </div>
                </div>
            </section>
            
            <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                <button id="startAR" class="start-ar-btn">
                    <i class="fas fa-cube"></i> Launch AR Experience
                </button>
                <button id="startNonAR" class="start-ar-btn" style="background: rgba(255,255,255,0.1); display: none;">
                    <i class="fas fa-eye-slash"></i> View Without AR
                </button>
            </div>
            
            <div class="footer">
                <p>WebAR Haber-Bosch Process Simulator | Designed for Chemical Engineering Education</p>
                <p style="margin-top: 10px; font-size: 0.8rem;">Optimized for iOS Safari & Android Chrome | Uses MindAR.js + Three.js</p>
            </div>
        </div>
    </div>

    <!-- AR Container -->
    <div id="arContainer">
        <div id="arScene"></div>
        <div class="ar-overlay">
            <div id="processVisualization" style="display: none;">
                <div class="visualization-title">
                    <i class="fas fa-stream"></i> Process Flow
                </div>
                <div class="process-flow">
                    <div class="flow-progress" id="flowProgress"></div>
                    <div class="flow-markers">
                        <div class="flow-marker" data-step="0" style="left: 0%;"></div>
                        <div class="flow-marker" data-step="1" style="left: 25%;"></div>
                        <div class="flow-marker" data-step="2" style="left: 50%;"></div>
                        <div class="flow-marker" data-step="3" style="left: 75%;"></div>
                        <div class="flow-marker" data-step="4" style="left: 100%;"></div>
                    </div>
                </div>
                <div class="flow-labels">
                    <span>Feed</span>
                    <span>Mix</span>
                    <span>React</span>
                    <span>Separate</span>
                    <span>Product</span>
                </div>
            </div>
            
            <div id="infoCard" class="info-card">
                <div class="info-card-header">
                    <h3 class="info-card-title" id="infoCardTitle">Component Name</h3>
                    <button class="close-card" id="closeCard">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="info-card-content">
                    <p id="componentDescription">Component description will appear here.</p>
                    
                    <div class="parameter-grid" id="parameterGrid">
                        <!-- Parameters will be inserted here -->
                    </div>
                    
                    <div class="chemical-equation" id="chemicalEquation" style="display: none;">
                        N₂ + 3H₂ ⇌ 2NH₃
                    </div>
                </div>
                <div class="info-audio-controls">
                    <button class="audio-btn" id="playAudio">
                        <i class="fas fa-play"></i> Play Explanation
                    </button>
                    <button class="audio-btn" id="repeatAudio" style="background: rgba(255,255,255,0.1);">
                        <i class="fas fa-redo"></i> Repeat
                    </button>
                </div>
            </div>
            
            <div id="controlPanel" style="display: none;">
                <div class="step-slider-container">
                    <span id="stepLabel">Step 1: Gas Feed</span>
                    <input type="range" min="0" max="4" value="0" class="slider" id="stepSlider">
                </div>
                
                <button class="control-btn" id="resetView" title="Reset View">
                    <i class="fas fa-sync-alt"></i>
                </button>
                
                <button class="control-btn" id="toggleAudio" title="Toggle Audio">
                    <i class="fas fa-volume-up"></i>
                </button>
                
                <button class="control-btn" id="toggleHelp" title="Show Help">
                    <i class="fas fa-question"></i>
                </button>
                
                <button class="control-btn" id="exitAR" title="Exit AR">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        // iOS Detection
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
        
        // Main Application Controller with iOS fixes
        class HaberBoschAR {
            constructor() {
                // State variables
                this.isARActive = false;
                this.isAudioEnabled = true;
                this.currentStep = 0;
                this.selectedComponent = null;
                this.lastAudioUtterance = null;
                this.isNonARMode = false;
                
                // AR variables
                this.mindARThree = null;
                this.renderer = null;
                this.scene = null;
                this.camera = null;
                
                // 3D objects
                this.components = {};
                this.particles = {
                    n2: [],
                    h2: [],
                    nh3: [],
                    recycle: []
                };
                
                // Component data (same as before)
                this.componentData = {
                    reactor: {
                        title: "Catalytic Reactor",
                        description: "The heart of the Haber-Bosch process where nitrogen and hydrogen gases react over an iron catalyst to form ammonia. The reactor operates at high temperature (400-500°C) and pressure (150-300 atm) to favor ammonia production.",
                        parameters: [
                            { label: "Temperature", value: "450°C" },
                            { label: "Pressure", value: "200 atm" },
                            { label: "Catalyst", value: "Fe3O4 + K2O" },
                            { label: "Conversion", value: "15-20%" }
                        ],
                        equation: "N₂ + 3H₂ ⇌ 2NH₃",
                        audioText: "The catalytic reactor is the core of the Haber-Bosch process. Nitrogen and hydrogen gases are passed over an iron-based catalyst at approximately 450 degrees Celsius and 200 atmospheres of pressure. Under these conditions, the gases react to form ammonia. The reaction is reversible and exothermic, with typical single-pass conversion rates of 15 to 20 percent."
                    },
                    nitrogenFeed: {
                        title: "Nitrogen Feed System",
                        description: "Supplies high-purity nitrogen gas extracted from air via cryogenic distillation or pressure swing adsorption. Nitrogen is compressed and purified before entering the reactor.",
                        parameters: [
                            { label: "Purity", value: ">99.9%" },
                            { label: "Source", value: "Air Separation" },
                            { label: "Pressure", value: "200 atm" },
                            { label: "Temperature", value: "30°C" }
                        ],
                        audioText: "The nitrogen feed system supplies high-purity nitrogen gas extracted from atmospheric air. This is typically achieved through cryogenic distillation or pressure swing adsorption processes. The nitrogen is then compressed to reactor pressure, approximately 200 atmospheres, and preheated before entering the catalytic reactor."
                    },
                    hydrogenFeed: {
                        title: "Hydrogen Feed System",
                        description: "Provides hydrogen gas typically produced from natural gas via steam methane reforming. Hydrogen is purified, compressed, and mixed with nitrogen in a 3:1 ratio.",
                        parameters: [
                            { label: "Purity", value: ">99.5%" },
                            { label: "Source", value: "Steam Reforming" },
                            { label: "H₂:N₂ Ratio", value: "3:1" },
                            { label: "Pressure", value: "200 atm" }
                        ],
                        audioText: "The hydrogen feed system delivers hydrogen gas to the reactor. In modern plants, hydrogen is primarily produced via steam methane reforming of natural gas. The hydrogen is purified to remove carbon monoxide and other impurities, then compressed to reactor pressure. It's mixed with nitrogen in a precise 3-to-1 molar ratio before entering the reactor."
                    },
                    separator: {
                        title: "Ammonia Separator",
                        description: "Cools the reactor effluent to liquefy ammonia. Unreacted nitrogen and hydrogen gases are separated and recycled back to the reactor feed.",
                        parameters: [
                            { label: "Temperature", value: "-20°C" },
                            { label: "Separation", value: "Condensation" },
                            { label: "NH₃ Purity", value: ">99.8%" },
                            { label: "Recycle Rate", value: "80-85%" }
                        ],
                        audioText: "The ammonia separator cools the reactor effluent to approximately minus 20 degrees Celsius, causing the ammonia to liquefy while unreacted nitrogen and hydrogen remain gaseous. The liquid ammonia is drawn off as product, while the unreacted gases are compressed and recycled back to the reactor inlet. This recycling is crucial for achieving high overall conversion rates."
                    },
                    storage: {
                        title: "Ammonia Storage Tank",
                        description: "Stores liquid ammonia under pressure or refrigeration. Ammonia is typically stored at -33°C at atmospheric pressure or at ambient temperature under pressure.",
                        parameters: [
                            { label: "State", value: "Liquid" },
                            { label: "Storage Temp", value: "-33°C" },
                            { label: "Capacity", value: "Variable" },
                            { label: "Pressure", value: "Atmospheric" }
                        ],
                        audioText: "The ammonia storage tank holds liquid ammonia product. Ammonia is typically stored at minus 33 degrees Celsius at atmospheric pressure, or at ambient temperature under pressure. From storage, ammonia can be transported for use in fertilizers, refrigerants, or as a chemical feedstock. The Haber-Bosch process produces over 150 million metric tons of ammonia annually worldwide."
                    },
                    recycleCompressor: {
                        title: "Recycle Compressor",
                        description: "Compresses unreacted nitrogen and hydrogen gases from the separator for reintroduction into the reactor feed. This improves overall conversion efficiency.",
                        parameters: [
                            { label: "Function", value: "Gas Recycle" },
                            { label: "Compression", value: "200 atm" },
                            { label: "Flow Rate", value: "High" },
                            { label: "Efficiency", value: ">85%" }
                        ],
                        audioText: "The recycle compressor takes unreacted nitrogen and hydrogen gases from the ammonia separator and compresses them back to reactor pressure for reintroduction into the feed stream. This recycling is essential for achieving high overall conversion efficiency in the Haber-Bosch process, as single-pass conversion is limited by thermodynamic equilibrium."
                    }
                };
                
                // Process steps
                this.processSteps = [
                    { label: "Step 1: Gas Feed", components: ["nitrogenFeed", "hydrogenFeed"] },
                    { label: "Step 2: Mixing & Compression", components: ["reactor"] },
                    { label: "Step 3: Catalytic Reaction", components: ["reactor"] },
                    { label: "Step 4: Separation", components: ["separator", "recycleCompressor"] },
                    { label: "Step 5: Storage", components: ["storage"] }
                ];
                
                // Initialize the application
                this.init();
            }
            
            async init() {
                // Show iOS warning if needed
                if (isIOS) {
                    document.getElementById('iosWarning').style.display = 'flex';
                    document.getElementById('startNonAR').style.display = 'inline-flex';
                }
                
                // Update loading text
                document.getElementById('loadingText').textContent = 'Loading 3D models and AR engine...';
                
                // Initialize Web Speech API
                this.initSpeechSynthesis();
                
                // Set up event listeners
                this.setupEventListeners();
                
                // Preload assets
                await this.preloadAssets();
                
                // Hide loading screen after a short delay
                setTimeout(() => {
                    document.getElementById('loadingScreen').style.opacity = '0';
                    setTimeout(() => {
                        document.getElementById('loadingScreen').style.display = 'none';
                    }, 500);
                }, 1000);
            }
            
            initSpeechSynthesis() {
                // Check browser support
                if (!('speechSynthesis' in window)) {
                    console.warn('Web Speech API not supported');
                    this.isAudioEnabled = false;
                }
                
                // Configure speech synthesis
                this.speechSynth = window.speechSynthesis;
                
                // Get available voices
                setTimeout(() => {
                    this.voices = this.speechSynth.getVoices();
                    // Prefer a female voice for better clarity
                    this.selectedVoice = this.voices.find(voice => 
                        voice.name.includes('Female') || voice.name.includes('Samantha') || voice.name.includes('Google UK English Female')
                    ) || this.voices[0];
                }, 500);
            }
            
            setupEventListeners() {
                // Start AR button
                document.getElementById('startAR').addEventListener('click', () => this.checkPermissionsAndStartAR());
                
                // Start Non-AR mode
                document.getElementById('startNonAR').addEventListener('click', () => this.startNonARMode());
                
                // Permission buttons
                document.getElementById('requestPermission').addEventListener('click', () => this.requestCameraPermission());
                document.getElementById('skipPermission').addEventListener('click', () => this.startNonARMode());
                
                // Control panel buttons
                document.getElementById('resetView').addEventListener('click', () => this.resetView());
                document.getElementById('toggleAudio').addEventListener('click', () => this.toggleAudio());
                document.getElementById('toggleHelp').addEventListener('click', () => this.showHelp());
                document.getElementById('exitAR').addEventListener('click', () => this.exitAR());
                
                // Info card buttons
                document.getElementById('closeCard').addEventListener('click', () => this.closeInfoCard());
                document.getElementById('playAudio').addEventListener('click', () => this.playComponentAudio());
                document.getElementById('repeatAudio').addEventListener('click', () => this.repeatAudio());
                
                // Step slider
                document.getElementById('stepSlider').addEventListener('input', (e) => this.changeStep(parseInt(e.target.value)));
                
                // Handle window resize
                window.addEventListener('resize', () => this.onWindowResize());
                
                // Handle page visibility change (iOS specific)
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden && this.isARActive) {
                        this.pauseAR();
                    } else if (!document.hidden && this.isARActive) {
                        this.resumeAR();
                    }
                });
            }
            
            async checkPermissionsAndStartAR() {
                // Check if we're on iOS Safari
                if (isIOS && isSafari) {
                    // iOS Safari requires user gesture for camera access
                    this.showPermissionPrompt();
                    return;
                }
                
                // For other browsers, check camera permissions
                try {
                    // Test camera access
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            facingMode: 'environment',
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        } 
                    });
                    
                    // Stop the stream immediately (we just needed permission)
                    stream.getTracks().forEach(track => track.stop());
                    
                    // Start AR
                    this.startAR();
                } catch (error) {
                    console.error('Camera permission denied:', error);
                    this.showPermissionPrompt();
                }
            }
            
            showPermissionPrompt() {
                document.getElementById('permissionPrompt').style.display = 'flex';
            }
            
            hidePermissionPrompt() {
                document.getElementById('permissionPrompt').style.display = 'none';
            }
            
            async requestCameraPermission() {
                try {
                    // For iOS, we need to create a video element and request camera
                    const video = document.createElement('video');
                    video.style.position = 'fixed';
                    video.style.top = '-1000px';
                    video.style.left = '-1000px';
                    video.style.width = '1px';
                    video.style.height = '1px';
                    document.body.appendChild(video);
                    
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            facingMode: 'environment'
                        } 
                    });
                    
                    video.srcObject = stream;
                    
                    // Wait a moment for iOS to register the permission
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    // Clean up
                    stream.getTracks().forEach(track => track.stop());
                    video.remove();
                    
                    // Hide permission prompt
                    this.hidePermissionPrompt();
                    
                    // Start AR
                    await this.startAR();
                    
                } catch (error) {
                    console.error('Failed to get camera permission:', error);
                    alert('Camera permission denied. You can still use the app in non-AR mode.');
                    this.startNonARMode();
                }
            }
            
            startNonARMode() {
                this.isNonARMode = true;
                this.hidePermissionPrompt();
                this.showNonARMode();
            }
            
            async showNonARMode() {
                // Show AR container but without camera feed
                document.getElementById('instructionView').style.display = 'none';
                document.getElementById('arContainer').style.display = 'block';
                document.getElementById('processVisualization').style.display = 'block';
                document.getElementById('controlPanel').style.display = 'flex';
                
                // Update loading
                document.getElementById('loadingScreen').style.display = 'flex';
                document.getElementById('loadingScreen').style.opacity = '1';
                document.getElementById('loadingText').textContent = 'Loading 3D visualization...';
                
                // Initialize Three.js scene without AR
                await this.initThreeJSScene();
                
                // Hide loading screen
                setTimeout(() => {
                    document.getElementById('loadingScreen').style.opacity = '0';
                    setTimeout(() => {
                        document.getElementById('loadingScreen').style.display = 'none';
                    }, 500);
                }, 1500);
                
                // Play welcome audio
                setTimeout(() => {
                    if (this.isAudioEnabled) {
                        this.speak("Welcome to the Haber-Bosch Process visualization. This is running in non-AR mode. Tap on any component to learn more about it.");
                    }
                }, 2000);
            }
            
            async initThreeJSScene() {
                // Create a basic Three.js scene for non-AR mode
                const container = document.getElementById('arScene');
                
                // Create scene
                this.scene = new THREE.Scene();
                this.scene.background = new THREE.Color(0x0d1b2a);
                
                // Create camera
                this.camera = new THREE.PerspectiveCamera(
                    75,
                    container.clientWidth / container.clientHeight,
                    0.1,
                    1000
                );
                this.camera.position.set(0, 5, 10);
                
                // Create renderer
                this.renderer = new THREE.WebGLRenderer({ 
                    antialias: true,
                    alpha: true,
                    powerPreference: "high-performance"
                });
                this.renderer.setSize(container.clientWidth, container.clientHeight);
                this.renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2)); // Limit for performance
                container.appendChild(this.renderer.domElement);
                
                // Add lighting
                this.addLighting();
                
                // Create 3D models
                this.create3DModels();
                
                // Add orbit controls for non-AR mode
                this.setupOrbitControls();
                
                // Start animation loop
                this.startAnimationLoop();
                
                // Set initial step
                this.changeStep(0);
            }
            
            setupOrbitControls() {
                // Simple manual orbit controls for non-AR mode
                let isDragging = false;
                let previousMousePosition = { x: 0, y: 0 };
                const container = document.getElementById('arScene');
                
                container.addEventListener('mousedown', (e) => {
                    isDragging = true;
                    previousMousePosition = { x: e.clientX, y: e.clientY };
                });
                
                container.addEventListener('mousemove', (e) => {
                    if (!isDragging || !this.modelsGroup) return;
                    
                    const deltaX = e.clientX - previousMousePosition.x;
                    const deltaY = e.clientY - previousMousePosition.y;
                    
                    this.modelsGroup.rotation.y += deltaX * 0.01;
                    this.modelsGroup.rotation.x += deltaY * 0.01;
                    
                    previousMousePosition = { x: e.clientX, y: e.clientY };
                });
                
                container.addEventListener('mouseup', () => {
                    isDragging = false;
                });
                
                container.addEventListener('mouseleave', () => {
                    isDragging = false;
                });
                
                // Touch events for mobile
                container.addEventListener('touchstart', (e) => {
                    isDragging = true;
                    previousMousePosition = { 
                        x: e.touches[0].clientX, 
                        y: e.touches[0].clientY 
                    };
                    e.preventDefault();
                });
                
                container.addEventListener('touchmove', (e) => {
                    if (!isDragging || !this.modelsGroup) return;
                    
                    const deltaX = e.touches[0].clientX - previousMousePosition.x;
                    const deltaY = e.touches[0].clientY - previousMousePosition.y;
                    
                    this.modelsGroup.rotation.y += deltaX * 0.01;
                    this.modelsGroup.rotation.x += deltaY * 0.01;
                    
                    previousMousePosition = { 
                        x: e.touches[0].clientX, 
                        y: e.touches[0].clientY 
                    };
                    e.preventDefault();
                });
                
                container.addEventListener('touchend', () => {
                    isDragging = false;
                });
                
                // Add zoom with wheel/pinch
                container.addEventListener('wheel', (e) => {
                    if (!this.modelsGroup) return;
                    
                    const zoomAmount = e.deltaY * 0.001;
                    this.modelsGroup.scale.x = Math.max(0.3, Math.min(1.5, this.modelsGroup.scale.x + zoomAmount));
                    this.modelsGroup.scale.y = Math.max(0.3, Math.min(1.5, this.modelsGroup.scale.y + zoomAmount));
                    this.modelsGroup.scale.z = Math.max(0.3, Math.min(1.5, this.modelsGroup.scale.z + zoomAmount));
                });
            }
            
            async preloadAssets() {
                return Promise.resolve();
            }
            
            async startAR() {
                try {
                    // Show AR container
                    document.getElementById('instructionView').style.display = 'none';
                    document.getElementById('arContainer').style.display = 'block';
                    document.getElementById('processVisualization').style.display = 'block';
                    document.getElementById('controlPanel').style.display = 'flex';
                    
                    // Update loading for AR
                    document.getElementById('loadingScreen').style.display = 'flex';
                    document.getElementById('loadingScreen').style.opacity = '1';
                    document.getElementById('loadingText').textContent = 'Initializing AR camera and 3D scene...';
                    
                    // Initialize MindAR
                    await this.initMindAR();
                    
                    // Hide loading screen
                    setTimeout(() => {
                        document.getElementById('loadingScreen').style.opacity = '0';
                        setTimeout(() => {
                            document.getElementById('loadingScreen').style.display = 'none';
                        }, 500);
                    }, 1500);
                    
                    // Start animation loop
                    this.startAnimationLoop();
                    
                    // Set initial step
                    this.changeStep(0);
                    
                    // Play welcome audio
                    setTimeout(() => {
                        if (this.isAudioEnabled) {
                            this.speak("Welcome to the Haber-Bosch Process AR Lab. Point your camera at the target image to begin. Tap on any component to learn more about it.");
                        }
                    }, 2000);
                    
                } catch (error) {
                    console.error('Failed to start AR:', error);
                    
                    // Try to fall back to non-AR mode
                    alert('AR initialization failed. Switching to non-AR mode.');
                    this.startNonARMode();
                }
            }
            
            async initMindAR() {
                try {
                    // Use a simple image target for iOS compatibility
                    const imageTargetSrc = isIOS 
                        ? 'https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/card-example/card.mind'
                        : 'https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/card-example/card.mind';
                    
                    // Initialize MindAR with iOS-optimized settings
                    const mindarThree = new window.MINDAR.IMAGE.MindARThree({
                        container: document.getElementById('arScene'),
                        imageTargetSrc: imageTargetSrc,
                        uiScanning: isIOS ? "no" : "yes", // Disable scanning UI on iOS for better performance
                        uiLoading: "yes",
                        uiError: "yes",
                        filterMinCF: 0.001,
                        filterBeta: 1000,
                        missTolerance: 10,
                        warmupTolerance: 5,
                        maxTrack: 2
                    });
                    
                    this.mindARThree = mindarThree;
                    this.renderer = mindarThree.renderer;
                    this.scene = mindarThree.scene;
                    this.camera = mindarThree.camera;
                    
                    // Configure renderer for iOS
                    if (isIOS) {
                        this.renderer.setPixelRatio(1); // Lower pixel ratio for better performance
                        this.renderer.outputEncoding = THREE.sRGBEncoding;
                    }
                    
                    // Start MindAR
                    await mindarThree.start();
                    
                    // Create 3D models
                    this.create3DModels();
                    
                    // Set up anchor
                    const anchor = mindarThree.addAnchor(0);
                    anchor.group.add(this.modelsGroup);
                    
                    // Add lighting
                    this.addLighting();
                    
                    // Handle anchor found/lost
                    anchor.onTargetFound = () => {
                        console.log('Target found');
                    };
                    
                    anchor.onTargetLost = () => {
                        console.log('Target lost');
                    };
                    
                    this.isARActive = true;
                    
                } catch (error) {
                    console.error('MindAR initialization failed:', error);
                    throw error;
                }
            }
            
            create3DModels() {
                // Create a group to hold all models
                this.modelsGroup = new THREE.Group();
                this.modelsGroup.position.set(0, 0, 0);
                this.modelsGroup.scale.set(0.5, 0.5, 0.5);
                
                // Create reactor
                this.createReactor();
                
                // Create feed systems
                this.createFeedSystems();
                
                // Create separator and storage
                this.createSeparationSystem();
                
                // Create recycle compressor
                this.createRecycleCompressor();
                
                // Add particle systems
                this.createParticleSystems();
                
                // Add the group to the scene
                this.scene.add(this.modelsGroup);
            }
            
            createReactor() {
                // Main reactor vessel
                const reactorGeometry = new THREE.CylinderGeometry(1.2, 1.2, 3, 16); // Reduced segments for performance
                const reactorMaterial = new THREE.MeshPhongMaterial({ 
                    color: 0x5a6268,
                    shininess: 30,
                    transparent: true,
                    opacity: 0.9
                });
                const reactor = new THREE.Mesh(reactorGeometry, reactorMaterial);
                reactor.position.set(0, 1.5, 0);
                reactor.userData = { component: 'reactor' };
                
                // Make interactive
                reactor.castShadow = false; // Disable shadow for performance
                reactor.receiveShadow = false;
                
                // Reactor head (top)
                const headGeometry = new THREE.CylinderGeometry(1.3, 1.2, 0.3, 16);
                const headMaterial = new THREE.MeshPhongMaterial({ color: 0x4a545c });
                const head = new THREE.Mesh(headGeometry, headMaterial);
                head.position.set(0, 3.15, 0);
                
                // Reactor bottom
                const bottomGeometry = new THREE.CylinderGeometry(1.2, 1.3, 0.3, 16);
                const bottom = new THREE.Mesh(bottomGeometry, headMaterial);
                bottom.position.set(0, -0.15, 0);
                
                // Internal catalyst bed (visualization)
                const catalystGeometry = new THREE.CylinderGeometry(1.1, 1.1, 2, 16);
                const catalystMaterial = new THREE.MeshPhongMaterial({ 
                    color: 0xa0522d,
                    transparent: true,
                    opacity: 0.6
                });
                const catalyst = new THREE.Mesh(catalystGeometry, catalystMaterial);
                catalyst.position.set(0, 1.5, 0);
                
                // Reactor group
                const reactorGroup = new THREE.Group();
                reactorGroup.add(reactor);
                reactorGroup.add(head);
                reactorGroup.add(bottom);
                reactorGroup.add(catalyst);
                
                // Add label
                this.addLabel(reactorGroup, "Catalytic Reactor", new THREE.Vector3(0, 3.8, 0));
                
                // Store reference
                this.components.reactor = reactorGroup;
                this.modelsGroup.add(reactorGroup);
                
                // Make interactive
                const interactiveReactor = this.createInteractiveMesh(reactor, 'reactor');
                reactorGroup.add(interactiveReactor);
            }
            
            createInteractiveMesh(mesh, componentId) {
                // Create a transparent mesh for interaction
                const geometry = mesh.geometry.clone();
                const material = new THREE.MeshBasicMaterial({
                    color: 0xffffff,
                    transparent: true,
                    opacity: 0.0
                });
                
                const interactiveMesh = new THREE.Mesh(geometry, material);
                interactiveMesh.position.copy(mesh.position);
                interactiveMesh.rotation.copy(mesh.rotation);
                interactiveMesh.scale.copy(mesh.scale);
                interactiveMesh.userData = { component: componentId };
                
                // Store reference for raycasting
                if (!this.interactiveMeshes) this.interactiveMeshes = [];
                this.interactiveMeshes.push(interactiveMesh);
                
                return interactiveMesh;
            }
            
            createFeedSystems() {
                // Nitrogen feed system
                const n2FeedGroup = new THREE.Group();
                n2FeedGroup.position.set(-2.5, 2, 0);
                
                // N2 feed pipe
                const n2PipeGeometry = new THREE.CylinderGeometry(0.2, 0.2, 2, 8); // Reduced segments
                const n2Material = new THREE.MeshPhongMaterial({ color: 0x4d8ac8 });
                const n2Pipe = new THREE.Mesh(n2PipeGeometry, n2Material);
                n2Pipe.rotation.z = Math.PI / 2;
                n2Pipe.position.set(0, 0, 0);
                
                // N2 feed tank
                const n2TankGeometry = new THREE.CylinderGeometry(0.5, 0.5, 1.2, 16);
                const n2Tank = new THREE.Mesh(n2TankGeometry, n2Material);
                n2Tank.position.set(-1.2, 0, 0);
                
                n2FeedGroup.add(n2Pipe);
                n2FeedGroup.add(n2Tank);
                this.addLabel(n2FeedGroup, "N₂ Feed", new THREE.Vector3(0, 1.5, 0));
                
                this.components.nitrogenFeed = n2FeedGroup;
                this.modelsGroup.add(n2FeedGroup);
                
                // Make interactive
                const interactiveN2 = this.createInteractiveMesh(n2Pipe, 'nitrogenFeed');
                n2FeedGroup.add(interactiveN2);
                
                // Hydrogen feed system
                const h2FeedGroup = new THREE.Group();
                h2FeedGroup.position.set(2.5, 2, 0);
                
                // H2 feed pipe
                const h2PipeGeometry = new THREE.CylinderGeometry(0.2, 0.2, 2, 8);
                const h2Material = new THREE.MeshPhongMaterial({ color: 0x2ecc71 });
                const h2Pipe = new THREE.Mesh(h2PipeGeometry, h2Material);
                h2Pipe.rotation.z = Math.PI / 2;
                h2Pipe.position.set(0, 0, 0);
                
                // H2 feed tank
                const h2TankGeometry = new THREE.CylinderGeometry(0.5, 0.5, 1.2, 16);
                const h2Tank = new THREE.Mesh(h2TankGeometry, h2Material);
                h2Tank.position.set(1.2, 0, 0);
                
                h2FeedGroup.add(h2Pipe);
                h2FeedGroup.add(h2Tank);
                this.addLabel(h2FeedGroup, "H₂ Feed", new THREE.Vector3(0, 1.5, 0));
                
                this.components.hydrogenFeed = h2FeedGroup;
                this.modelsGroup.add(h2FeedGroup);
                
                // Make interactive
                const interactiveH2 = this.createInteractiveMesh(h2Pipe, 'hydrogenFeed');
                h2FeedGroup.add(interactiveH2);
            }
            
            createSeparationSystem() {
                // Separator
                const separatorGroup = new THREE.Group();
                separatorGroup.position.set(2, -1, 0);
                
                // Separator vessel
                const separatorGeometry = new THREE.CylinderGeometry(0.8, 0.8, 2, 16);
                const separatorMaterial = new THREE.MeshPhongMaterial({ color: 0x7f8c8d });
                const separator = new THREE.Mesh(separatorGeometry, separatorMaterial);
                separator.position.set(0, 1, 0);
                
                // Separator dome
                const domeGeometry = new THREE.SphereGeometry(0.8, 16, 8, 0, Math.PI * 2, 0, Math.PI / 2);
                const dome = new THREE.Mesh(domeGeometry, separatorMaterial);
                dome.position.set(0, 2, 0);
                
                separatorGroup.add(separator);
                separatorGroup.add(dome);
                this.addLabel(separatorGroup, "Separator", new THREE.Vector3(0, 2.8, 0));
                
                this.components.separator = separatorGroup;
                this.modelsGroup.add(separatorGroup);
                
                // Make interactive
                const interactiveSeparator = this.createInteractiveMesh(separator, 'separator');
                separatorGroup.add(interactiveSeparator);
                
                // Storage tank
                const storageGroup = new THREE.Group();
                storageGroup.position.set(0, -2.5, 0);
                
                // Storage sphere
                const storageGeometry = new THREE.SphereGeometry(1, 16, 16);
                const storageMaterial = new THREE.MeshPhongMaterial({ color: 0xe67e22 });
                const storage = new THREE.Mesh(storageGeometry, storageMaterial);
                
                storageGroup.add(storage);
                this.addLabel(storageGroup, "NH₃ Storage", new THREE.Vector3(0, -1.5, 0));
                
                this.components.storage = storageGroup;
                this.modelsGroup.add(storageGroup);
                
                // Make interactive
                const interactiveStorage = this.createInteractiveMesh(storage, 'storage');
                storageGroup.add(interactiveStorage);
            }
            
            createRecycleCompressor() {
                const compressorGroup = new THREE.Group();
                compressorGroup.position.set(-2, -1, 0);
                
                // Compressor body
                const compressorGeometry = new THREE.BoxGeometry(1, 1.5, 1);
                const compressorMaterial = new THREE.MeshPhongMaterial({ color: 0x95a5a6 });
                const compressor = new THREE.Mesh(compressorGeometry, compressorMaterial);
                compressor.position.set(0, 0.75, 0);
                
                // Inlet and outlet pipes
                const pipeGeometry = new THREE.CylinderGeometry(0.1, 0.1, 0.8, 8);
                const pipeMaterial = new THREE.MeshPhongMaterial({ color: 0x7f8c8d });
                
                const inletPipe = new THREE.Mesh(pipeGeometry, pipeMaterial);
                inletPipe.rotation.z = Math.PI / 2;
                inletPipe.position.set(-0.6, 0.5, 0);
                
                const outletPipe = new THREE.Mesh(pipeGeometry, pipeMaterial);
                outletPipe.rotation.z = Math.PI / 2;
                outletPipe.position.set(0.6, 1, 0);
                
                compressorGroup.add(compressor);
                compressorGroup.add(inletPipe);
                compressorGroup.add(outletPipe);
                this.addLabel(compressorGroup, "Recycle Compressor", new THREE.Vector3(0, 2, 0));
                
                this.components.recycleCompressor = compressorGroup;
                this.modelsGroup.add(compressorGroup);
                
                // Make interactive
                const interactiveCompressor = this.createInteractiveMesh(compressor, 'recycleCompressor');
                compressorGroup.add(interactiveCompressor);
            }
            
            createParticleSystems() {
                // Create simplified particle systems for better performance
                if (!isIOS) { // Skip particles on iOS for better performance
                    this.createParticleStream(
                        this.components.nitrogenFeed, 
                        this.components.reactor, 
                        0x4d8ac8, 
                        'n2',
                        8 // Reduced particle count
                    );
                    
                    this.createParticleStream(
                        this.components.hydrogenFeed, 
                        this.components.reactor, 
                        0x2ecc71, 
                        'h2',
                        8
                    );
                }
            }
            
            createParticleStream(startObj, endObj, color, type, count) {
                const particles = [];
                const particleGeometry = new THREE.SphereGeometry(0.05, 4, 4); // Reduced detail
                const particleMaterial = new THREE.MeshBasicMaterial({ color: color });
                
                // Get start and end positions
                const startPos = startObj.position.clone();
                const endPos = endObj.position.clone();
                
                // Create particles
                for (let i = 0; i < count; i++) {
                    const particle = new THREE.Mesh(particleGeometry, particleMaterial);
                    particle.visible = false;
                    this.modelsGroup.add(particle);
                    particles.push({
                        mesh: particle,
                        progress: Math.random(),
                        speed: 0.005 + Math.random() * 0.01,
                        offset: Math.random() * Math.PI * 2
                    });
                }
                
                // Store based on type
                if (type === 'n2') this.particles.n2 = particles;
                else if (type === 'h2') this.particles.h2 = particles;
                else if (type === 'nh3') this.particles.nh3 = particles;
                else if (type === 'recycle') this.particles.recycle = particles;
            }
            
            addLabel(object, text, position) {
                // Create a canvas for the label
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.width = 256; // Reduced size for performance
                canvas.height = 64;
                
                // Draw text
                context.fillStyle = 'rgba(13, 27, 42, 0.9)';
                context.fillRect(0, 0, canvas.width, canvas.height);
                
                context.font = 'bold 24px Inter, sans-serif';
                context.textAlign = 'center';
                context.textBaseline = 'middle';
                context.fillStyle = '#e0e1dd';
                context.fillText(text, canvas.width / 2, canvas.height / 2);
                
                // Create texture
                const texture = new THREE.CanvasTexture(canvas);
                const labelMaterial = new THREE.SpriteMaterial({ map: texture });
                const label = new THREE.Sprite(labelMaterial);
                label.position.copy(position);
                label.scale.set(1.5, 0.4, 1); // Reduced scale
                
                object.add(label);
                return label;
            }
            
            addLighting() {
                // Simplified lighting for better performance
                const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
                this.scene.add(ambientLight);
                
                const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
                directionalLight.position.set(5, 10, 5);
                this.scene.add(directionalLight);
            }
            
            onComponentClick(componentId) {
                // Update selected component
                this.selectedComponent = componentId;
                
                // Show info card
                this.showInfoCard(componentId);
                
                // Highlight the component
                this.highlightComponent(componentId);
                
                // Play audio explanation
                if (this.isAudioEnabled) {
                    this.playComponentAudio();
                }
            }
            
            showInfoCard(componentId) {
                const data = this.componentData[componentId];
                const card = document.getElementById('infoCard');
                
                // Update card content
                document.getElementById('componentDescription').textContent = data.description;
                document.getElementById('infoCardTitle').textContent = data.title;
                
                // Update parameters
                const paramGrid = document.getElementById('parameterGrid');
                paramGrid.innerHTML = '';
                
                data.parameters.forEach(param => {
                    const paramEl = document.createElement('div');
                    paramEl.className = 'parameter';
                    paramEl.innerHTML = `
                        <div class="parameter-label">${param.label}</div>
                        <div class="parameter-value">${param.value}</div>
                    `;
                    paramGrid.appendChild(paramEl);
                });
                
                // Show/hide chemical equation
                const equationEl = document.getElementById('chemicalEquation');
                if (data.equation) {
                    equationEl.textContent = data.equation;
                    equationEl.style.display = 'block';
                } else {
                    equationEl.style.display = 'none';
                }
                
                // Show card
                card.classList.add('active');
            }
            
            closeInfoCard() {
                document.getElementById('infoCard').classList.remove('active');
                
                // Remove highlight from component
                if (this.selectedComponent) {
                    this.removeHighlight(this.selectedComponent);
                }
            }
            
            highlightComponent(componentId) {
                // Remove any existing highlights
                Object.keys(this.components).forEach(id => {
                    this.removeHighlight(id);
                });
                
                // Add highlight to selected component
                const component = this.components[componentId];
                if (component) {
                    component.traverse(child => {
                        if (child.isMesh && child.material && child.material.emissive) {
                            child.material.emissive = new THREE.Color(0x333333);
                            child.material.emissiveIntensity = 0.5;
                        }
                    });
                }
            }
            
            removeHighlight(componentId) {
                const component = this.components[componentId];
                if (component) {
                    component.traverse(child => {
                        if (child.isMesh && child.material && child.material.emissive) {
                            child.material.emissive = new THREE.Color(0x000000);
                            child.material.emissiveIntensity = 0;
                        }
                    });
                }
            }
            
            playComponentAudio() {
                if (!this.selectedComponent || !this.isAudioEnabled) return;
                
                const data = this.componentData[this.selectedComponent];
                this.speak(data.audioText);
            }
            
            repeatAudio() {
                if (this.lastAudioUtterance) {
                    this.speechSynth.cancel();
                    this.speak(this.lastAudioUtterance.text);
                }
            }
            
            speak(text) {
                if (!this.isAudioEnabled || !this.speechSynth) return;
                
                // Cancel any ongoing speech
                this.speechSynth.cancel();
                
                // Create new utterance
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = 0.9;
                utterance.pitch = 1.0;
                utterance.volume = 1.0;
                
                // Use selected voice if available
                if (this.selectedVoice) {
                    utterance.voice = this.selectedVoice;
                }
                
                // Store last utterance for repeat functionality
                this.lastAudioUtterance = utterance;
                
                // Speak
                this.speechSynth.speak(utterance);
            }
            
            changeStep(stepIndex) {
                this.currentStep = stepIndex;
                
                // Update UI
                document.getElementById('stepSlider').value = stepIndex;
                document.getElementById('stepLabel').textContent = this.processSteps[stepIndex].label;
                
                // Update visualization
                document.getElementById('flowProgress').style.width = `${(stepIndex / 4) * 100}%`;
                
                // Update flow markers
                document.querySelectorAll('.flow-marker').forEach((marker, i) => {
                    if (i <= stepIndex) {
                        marker.classList.add('active');
                    } else {
                        marker.classList.remove('active');
                    }
                });
                
                // Highlight relevant components
                this.highlightStepComponents(stepIndex);
            }
            
            highlightStepComponents(stepIndex) {
                // Remove all highlights first
                Object.keys(this.components).forEach(id => {
                    this.removeHighlight(id);
                });
                
                // Highlight components for this step
                const step = this.processSteps[stepIndex];
                step.components.forEach(componentId => {
                    const component = this.components[componentId];
                    if (component) {
                        component.traverse(child => {
                            if (child.isMesh && child.material && child.material.emissive) {
                                child.material.emissive = new THREE.Color(0x111111);
                                child.material.emissiveIntensity = 0.3;
                            }
                        });
                    }
                });
            }
            
            startAnimationLoop() {
                // Set up raycaster for interaction
                this.raycaster = new THREE.Raycaster();
                this.mouse = new THREE.Vector2();
                
                // Set up click/touch handler
                const container = document.getElementById('arScene');
                
                const handleInteraction = (clientX, clientY) => {
                    // Calculate mouse position in normalized device coordinates
                    const rect = container.getBoundingClientRect();
                    this.mouse.x = ((clientX - rect.left) / rect.width) * 2 - 1;
                    this.mouse.y = -((clientY - rect.top) / rect.height) * 2 + 1;
                    
                    // Update the picking ray with the camera and mouse position
                    this.raycaster.setFromCamera(this.mouse, this.camera);
                    
                    // Calculate objects intersecting the picking ray
                    if (this.interactiveMeshes) {
                        const intersects = this.raycaster.intersectObjects(this.interactiveMeshes);
                        
                        if (intersects.length > 0) {
                            const componentId = intersects[0].object.userData.component;
                            this.onComponentClick(componentId);
                        }
                    }
                };
                
                // Mouse click
                container.addEventListener('click', (e) => {
                    handleInteraction(e.clientX, e.clientY);
                });
                
                // Touch (for mobile)
                container.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    handleInteraction(e.changedTouches[0].clientX, e.changedTouches[0].clientY);
                });
                
                // Animation loop
                const animate = () => {
                    requestAnimationFrame(animate);
                    
                    if (this.renderer && this.scene && this.camera) {
                        // Update particle systems
                        this.updateParticles();
                        
                        // Update reactor animation
                        this.updateReactorAnimation();
                        
                        // Render scene
                        this.renderer.render(this.scene, this.camera);
                    }
                };
                
                animate();
            }
            
            updateParticles() {
                // Skip particle updates on iOS for better performance
                if (isIOS) return;
                
                // Update N2 particles
                this.particles.n2.forEach(particle => {
                    particle.progress += particle.speed;
                    if (particle.progress > 1) particle.progress = 0;
                    
                    // Calculate position along path
                    const startPos = this.components.nitrogenFeed.position.clone();
                    const endPos = this.components.reactor.position.clone();
                    
                    const x = startPos.x + (endPos.x - startPos.x) * particle.progress;
                    const y = startPos.y + (endPos.y - startPos.y) * particle.progress;
                    const z = startPos.z + (endPos.z - startPos.z) * particle.progress;
                    
                    // Add some randomness
                    const offset = Math.sin(particle.progress * Math.PI * 2 + particle.offset) * 0.2;
                    
                    particle.mesh.position.set(x + offset, y, z);
                    particle.mesh.visible = (this.currentStep >= 0);
                });
                
                // Update H2 particles
                this.particles.h2.forEach(particle => {
                    particle.progress += particle.speed;
                    if (particle.progress > 1) particle.progress = 0;
                    
                    const startPos = this.components.hydrogenFeed.position.clone();
                    const endPos = this.components.reactor.position.clone();
                    
                    const x = startPos.x + (endPos.x - startPos.x) * particle.progress;
                    const y = startPos.y + (endPos.y - startPos.y) * particle.progress;
                    const z = startPos.z + (endPos.z - startPos.z) * particle.progress;
                    
                    const offset = Math.sin(particle.progress * Math.PI * 2 + particle.offset) * 0.2;
                    
                    particle.mesh.position.set(x + offset, y, z);
                    particle.mesh.visible = (this.currentStep >= 0);
                });
            }
            
            updateReactorAnimation() {
                // Animate reactor internal mixer
                if (this.components.reactor && this.currentStep >= 2) {
                    const catalyst = this.components.reactor.children[3]; // Catalyst bed
                    if (catalyst) {
                        catalyst.rotation.y += 0.01;
                    }
                }
            }
            
            resetView() {
                // Reset model group position and rotation
                if (this.modelsGroup) {
                    this.modelsGroup.position.set(0, 0, 0);
                    this.modelsGroup.rotation.set(0, 0, 0);
                    this.modelsGroup.scale.set(0.5, 0.5, 0.5);
                }
            }
            
            toggleAudio() {
                this.isAudioEnabled = !this.isAudioEnabled;
                const btn = document.getElementById('toggleAudio');
                
                if (this.isAudioEnabled) {
                    btn.innerHTML = '<i class="fas fa-volume-up"></i>';
                    btn.title = 'Mute Audio';
                } else {
                    btn.innerHTML = '<i class="fas fa-volume-mute"></i>';
                    btn.title = 'Unmute Audio';
                    this.speechSynth.cancel();
                }
            }
            
            showHelp() {
                const mode = this.isNonARMode ? "non-AR" : "AR";
                this.speak(`You are viewing an interactive ${mode} model of the Haber-Bosch ammonia synthesis process. Tap on any component to learn about its function. Use the slider at the bottom to step through the process stages. The toggle buttons control audio, reset the view, and exit the ${mode} mode.`);
            }
            
            pauseAR() {
                if (this.mindARThree && this.isARActive) {
                    this.mindARThree.stop();
                }
            }
            
            resumeAR() {
                if (this.mindARThree && this.isARActive) {
                    this.mindARThree.start();
                }
            }
            
            exitAR() {
                // Stop AR
                if (this.mindARThree) {
                    this.mindARThree.stop();
                }
                
                // Stop any audio
                if (this.speechSynth) {
                    this.speechSynth.cancel();
                }
                
                // Clean up Three.js
                if (this.renderer) {
                    this.renderer.dispose();
                    const container = document.getElementById('arScene');
                    if (container.firstChild) {
                        container.removeChild(container.firstChild);
                    }
                }
                
                // Show instruction view
                document.getElementById('instructionView').style.display = 'block';
                document.getElementById('arContainer').style.display = 'none';
                
                // Reset state
                this.isARActive = false;
                this.isNonARMode = false;
                this.selectedComponent = null;
                this.closeInfoCard();
                
                // Show both start buttons again
                document.getElementById('startNonAR').style.display = 'inline-flex';
            }
            
            onWindowResize() {
                if (this.renderer && this.camera) {
                    const container = document.getElementById('arScene');
                    this.camera.aspect = container.clientWidth / container.clientHeight;
                    this.camera.updateProjectionMatrix();
                    this.renderer.setSize(container.clientWidth, container.clientHeight);
                }
            }
        }

        // Initialize the application when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            // Add a temporary event listener for iOS gesture handling
            if (isIOS) {
                document.addEventListener('touchstart', function() {}, {passive: true});
            }
            
            window.haberBoschAR = new HaberBoschAR();
        });
        
        // Prevent iOS rubber band effect
        document.addEventListener('touchmove', function(e) {
            if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
                e.preventDefault();
            }
        }, { passive: false });
    </script>
</body>
</html>
