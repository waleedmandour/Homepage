<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <title>Bionic Arm Engineering Lab | Advanced Mechatronics WebAR Simulation</title>
    <meta name="theme-color" content="#0b1120">
    <meta name="description" content="Advanced WebAR simulation of bionic arm mechatronics with real-time biomechanics, interactive components, and engineering language learning.">
    
    <!-- Dependencies -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-three.prod.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.4/howler.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-dark: #0b1120;
            --glass-panel: rgba(16, 24, 40, 0.92);
            --glass-border: rgba(56, 189, 248, 0.4);
            --accent-cyan: #38bdf8;
            --accent-green: #10b981;
            --accent-orange: #f59e0b;
            --accent-purple: #8b5cf6;
            --accent-danger: #ef4444;
            --accent-pink: #ec4899;
            --accent-teal: #14b8a6;
            --text-main: #e2e8f0;
            --text-muted: #94a3b8;
            --font-tech: 'Rajdhani', sans-serif;
            --font-code: 'Roboto Mono', monospace;
            --glow-cyan: 0 0 20px rgba(56, 189, 248, 0.5);
            --glow-green: 0 0 20px rgba(16, 185, 129, 0.5);
            --glow-pink: 0 0 20px rgba(236, 72, 153, 0.5);
        }

        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
            user-select: none; 
        }

        body {
            font-family: var(--font-tech);
            background: var(--bg-dark);
            color: var(--text-main);
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            transition: background 0.5s ease;
        }

        /* AR Transparent Mode */
        body.ar-active { 
            background: transparent !important; 
        }

        /* UI Containers */
        .hud-container {
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%;
            pointer-events: none; 
            z-index: 100;
            display: flex; 
            flex-direction: column; 
            justify-content: space-between;
            padding: env(safe-area-inset-top) 20px env(safe-area-inset-bottom) 20px;
        }

        .pointer-events-auto { 
            pointer-events: auto; 
        }

        /* Status Bar */
        .top-bar { 
            display: flex; 
            justify-content: space-between; 
            align-items: flex-start; 
            padding-top: 20px; 
        }
        
        .status-badge {
            background: var(--glass-panel); 
            border: 1px solid var(--glass-border);
            border-radius: 8px; 
            padding: 10px 20px; 
            backdrop-filter: blur(20px);
            display: flex; 
            align-items: center; 
            gap: 12px; 
            transition: all 0.3s;
            box-shadow: var(--glow-cyan);
        }
        
        .status-dot {
            width: 10px; 
            height: 10px; 
            border-radius: 50%;
            background: var(--accent-green); 
            box-shadow: 0 0 15px var(--accent-green);
            animation: pulse 2s infinite;
        }

        /* Critical State for Bionic Arm */
        .critical-state .status-badge { 
            border-color: var(--accent-pink); 
            box-shadow: 0 0 30px rgba(236, 72, 153, 0.5);
            animation: shake 0.5s infinite;
        }
        .critical-state .status-dot { 
            background: var(--accent-pink); 
            box-shadow: 0 0 20px var(--accent-pink); 
            animation: flash 0.3s infinite; 
        }
        .critical-state .tech-title h1 { 
            color: var(--accent-pink); 
        }

        .tech-title h1 { 
            font-size: 1.3rem; 
            text-transform: uppercase; 
            letter-spacing: 2px; 
            color: var(--accent-cyan); 
            font-weight: 700;
        }
        .tech-title span { 
            font-family: var(--font-code); 
            font-size: 0.75rem; 
            color: var(--text-muted); 
            letter-spacing: 1px;
        }

        /* Enhanced Side Panels */
        .side-panel {
            position: absolute; 
            top: 90px; 
            width: 320px;
            background: var(--glass-panel); 
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(20px); 
            padding: 24px;
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: auto; 
            max-height: 70vh; 
            overflow-y: auto;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            transform: translateX(-120%);
            opacity: 0;
            z-index: 150;
        }

        .control-room-panel { 
            left: 20px; 
            border-left: 4px solid var(--accent-teal); 
        }
        .quiz-panel { 
            right: 20px; 
            border-right: 4px solid var(--accent-orange);
            transform: translateX(120%);
        }
        .data-panel { 
            right: 20px; 
            border-right: 4px solid var(--accent-purple); 
            display: none;
        }
        .game-panel {
            left: 20px;
            border-left: 4px solid var(--accent-pink);
            display: none;
        }
        .side-panel.active { 
            transform: translateX(0);
            opacity: 1;
        }

        .panel-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 20px; 
            border-bottom: 1px solid rgba(255,255,255,0.15); 
            padding-bottom: 12px; 
        }
        .panel-label { 
            font-size: 1rem; 
            font-weight: 700; 
            color: var(--accent-cyan); 
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .close-btn {
            width: 32px; 
            height: 32px; 
            border-radius: 50%; 
            border: none; 
            background: rgba(255,255,255,0.1);
            color: var(--text-muted); 
            font-size: 1rem; 
            cursor: pointer; 
            transition: all 0.3s;
            display: flex; 
            align-items: center; 
            justify-content: center;
            position: relative;
            z-index: 160;
        }
        .close-btn:hover {
            background: rgba(255,255,255,0.2);
            transform: scale(1.1);
            color: var(--accent-cyan);
        }

        /* Enhanced Controls for Bionic Arm */
        .slider-group { 
            margin-bottom: 20px; 
            padding: 12px;
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
        }
        .slider-header { 
            display: flex; 
            justify-content: space-between; 
            margin-bottom: 8px; 
        }
        .slider-label { 
            font-size: 0.85rem; 
            color: var(--text-muted); 
            font-weight: 500;
        }
        .slider-value { 
            font-family: var(--font-code); 
            font-size: 1rem; 
            color: var(--accent-teal); 
            font-weight: 600;
        }
        
        input[type="range"] {
            width: 100%; 
            height: 6px; 
            background: linear-gradient(90deg, var(--accent-teal), var(--accent-pink));
            outline: none; 
            -webkit-appearance: none; 
            border-radius: 3px;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; 
            width: 20px; 
            height: 20px;
            background: white; 
            border-radius: 50%; 
            cursor: pointer;
            box-shadow: var(--glow-cyan);
            border: 2px solid var(--accent-teal);
        }

        .parameter-display {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 15px;
        }
        .param-box {
            background: rgba(0,0,0,0.3); 
            border-radius: 8px; 
            padding: 12px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .param-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 4px;
        }
        .param-value {
            font-size: 1.2rem;
            font-weight: 700;
            font-family: var(--font-code);
        }
        .param-value.torque { color: #f97316; }
        .param-value.power { color: #8b5cf6; }
        .param-value.signal { color: #10b981; }
        .param-value.battery { color: var(--accent-teal); }
        .param-value.force { color: var(--accent-pink); }

        /* Game Panel Styles */
        .game-instruction {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-bottom: 20px;
            line-height: 1.5;
            padding: 12px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
        }
        
        .game-objective {
            font-size: 1rem;
            color: var(--accent-pink);
            font-weight: bold;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .game-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }
        
        .game-btn {
            padding: 12px;
            background: linear-gradient(90deg, var(--accent-pink), #db2777);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            font-family: var(--font-tech);
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s;
        }
        
        .game-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(236, 72, 153, 0.4);
        }
        
        .game-btn:disabled {
            background: #6b7280;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .game-progress {
            width: 100%;
            height: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .game-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-pink), #ec4899);
            width: 0%;
            transition: width 0.5s ease;
            border-radius: 4px;
        }
        
        .game-score {
            text-align: center;
            font-size: 1.5rem;
            color: var(--accent-pink);
            font-weight: bold;
            margin: 10px 0;
        }
        
        .game-timer {
            font-family: var(--font-code);
            color: var(--accent-orange);
            font-size: 1.2rem;
            text-align: center;
            margin: 10px 0;
        }

        /* Enhanced Quiz UI */
        .quiz-question { 
            font-size: 1rem; 
            margin-bottom: 20px; 
            line-height: 1.5;
            background: rgba(255,255,255,0.05);
            padding: 12px;
            border-radius: 8px;
        }
        .quiz-options { 
            display: flex; 
            flex-direction: column; 
            gap: 10px; 
        }
        .quiz-btn {
            background: rgba(255,255,255,0.07); 
            border: 1px solid rgba(255,255,255,0.1);
            padding: 12px 16px; 
            border-radius: 8px; 
            color: var(--text-muted);
            text-align: left; 
            cursor: pointer; 
            transition: all 0.3s; 
            font-size: 0.9rem;
        }
        .quiz-btn:hover { 
            background: rgba(255,255,255,0.15); 
            transform: translateX(4px);
        }
        .quiz-btn.correct { 
            background: rgba(16, 185, 129, 0.25); 
            border-color: var(--accent-green); 
            color: var(--accent-green); 
        }
        .quiz-btn.wrong { 
            background: rgba(239, 68, 68, 0.25); 
            border-color: var(--accent-danger); 
            color: var(--accent-danger); 
        }
        .next-q-btn { 
            margin-top: 20px; 
            width: 100%; 
            padding: 12px; 
            background: var(--accent-cyan); 
            border: none; 
            border-radius: 8px; 
            font-weight: bold; 
            cursor: pointer; 
            display: none;
            font-family: var(--font-tech);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Bottom Controls */
        .bottom-dock { 
            display: flex; 
            flex-direction: column; 
            gap: 15px; 
            align-items: center; 
            width: 100%; 
            padding-bottom: 30px; 
        }
        .mode-toggles { 
            display: flex; 
            gap: 10px; 
            background: var(--glass-panel); 
            padding: 12px; 
            border-radius: 30px; 
            border: 1px solid rgba(255,255,255,0.15); 
            pointer-events: auto; 
            backdrop-filter: blur(20px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        .icon-btn {
            width: 48px; 
            height: 48px; 
            border-radius: 50%; 
            border: none; 
            background: rgba(255,255,255,0.1);
            color: var(--text-muted); 
            font-size: 1.2rem; 
            cursor: pointer; 
            transition: all 0.3s;
            display: flex; 
            align-items: center; 
            justify-content: center;
            position: relative;
        }
        .icon-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .icon-btn.active { 
            background: var(--accent-teal); 
            color: #000; 
            box-shadow: 0 0 15px rgba(20, 184, 166, 0.5);
        }
        .icon-btn.badge::after {
            content: '';
            position: absolute;
            top: 8px;
            right: 8px;
            width: 8px;
            height: 8px;
            background: var(--accent-pink);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        /* Neural Signal Visualization */
        .signal-popup {
            position: absolute; 
            right: 20px; 
            bottom: 140px; 
            width: 250px; 
            height: 160px;
            background: var(--glass-panel); 
            border: 2px solid var(--accent-green); 
            border-radius: 16px;
            display: none; 
            flex-direction: column; 
            align-items: center; 
            padding: 15px; 
            backdrop-filter: blur(20px);
            box-shadow: var(--glow-green);
            z-index: 140;
        }
        .signal-canvas { 
            width: 100%; 
            height: 120px; 
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
        }
        .signal-label { 
            font-family: var(--font-code); 
            color: var(--accent-green); 
            font-size: 1rem; 
            font-weight: 600;
            margin-top: 10px;
        }

        /* Enhanced Screens */
        #loadingScreen, #startScreen, #targetModal {
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%;
            background: var(--bg-dark); 
            z-index: 1000;
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center;
        }
        #targetModal { 
            background: rgba(0,0,0,0.95); 
            z-index: 2000; 
            display: none; 
        }

        .loader-ring {
            width: 80px; 
            height: 80px; 
            border: 4px solid rgba(56, 189, 248, 0.2);
            border-top-color: var(--accent-cyan); 
            border-radius: 50%; 
            animation: spin 1.5s linear infinite;
        }

        .btn-primary {
            margin-top: 30px; 
            padding: 16px 48px; 
            background: linear-gradient(90deg, var(--accent-teal), #0d9488);
            color: #000; 
            border: none; 
            border-radius: 8px; 
            font-family: var(--font-tech); 
            font-weight: 700;
            font-size: 1.2rem; 
            text-transform: uppercase; 
            letter-spacing: 1px; 
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 20px rgba(20, 184, 166, 0.3);
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(20, 184, 166, 0.4);
        }
        .btn-secondary { 
            margin-top: 15px; 
            background: transparent; 
            color: var(--text-muted); 
            border: 2px solid rgba(255,255,255,0.3); 
            padding: 12px 24px; 
            cursor: pointer; 
            font-family: var(--font-code); 
            font-size: 0.9rem; 
            border-radius: 8px;
            transition: all 0.3s;
        }
        .btn-secondary:hover {
            border-color: var(--accent-teal);
            color: var(--accent-teal);
        }
        .btn-text { 
            margin-top: 10px; 
            background: none; 
            border: none; 
            color: var(--accent-teal); 
            text-decoration: underline; 
            cursor: pointer; 
            font-size: 0.9rem; 
            transition: all 0.3s;
        }
        .btn-text:hover {
            text-shadow: 0 0 10px rgba(20, 184, 166, 0.5);
        }

        .target-image-display {
            width: 300px; 
            height: 300px; 
            background: linear-gradient(135deg, #14b8a6 0%, #0d9488 100%);
            border-radius: 16px; 
            margin-bottom: 20px;
            color: white; 
            text-align: center; 
            padding: 30px; 
            display: flex; 
            flex-direction: column; 
            justify-content: center;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }

        .star-pop { 
            animation: popIn 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        /* Data Stream */
        .data-stream {
            position: absolute;
            bottom: 120px;
            left: 20px;
            width: 300px;
            background: var(--glass-panel);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 15px;
            backdrop-filter: blur(20px);
            display: none;
            pointer-events: auto;
        }
        .data-stream.active {
            display: block;
            animation: slideUp 0.5s ease;
        }

        /* Achievement System */
        .achievement-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #1e293b, #0f172a);
            border: 2px solid var(--accent-pink);
            border-radius: 16px;
            padding: 20px;
            z-index: 1000;
            display: none;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0,0,0,0.5);
            min-width: 300px;
        }
        .achievement-icon {
            font-size: 3rem;
            color: gold;
            margin-bottom: 15px;
        }

        /* Object to Grab in Game */
        .game-object {
            position: absolute;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            pointer-events: none;
            z-index: 50;
        }

        /* Animations */
        @keyframes spin { 
            to { 
                transform: rotate(360deg); 
            } 
        }
        @keyframes pulse { 
            0% { 
                opacity: 1; 
            } 
            50% { 
                opacity: 0.5; 
            } 
            100% { 
                opacity: 1; 
            } 
        }
        @keyframes flash { 
            0% { 
                opacity: 1; 
            } 
            50% { 
                opacity: 0.2; 
            } 
            100% { 
                opacity: 1; 
            } 
        }
        @keyframes popIn { 
            0% { 
                transform: scale(0) rotate(-180deg); 
                opacity: 0; 
            }
            100% { 
                transform: scale(1) rotate(0deg); 
                opacity: 1; 
            }
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        @keyframes slideUp {
            from { 
                transform: translateY(20px);
                opacity: 0;
            }
            to { 
                transform: translateY(0);
                opacity: 1;
            }
        }
        @keyframes pulseSignal {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        video { 
            transform: scaleX(-1) !important; 
        }
        .ar-target-guide {
            width: 250px; 
            height: 250px; 
            border: 3px dashed var(--accent-teal);
            border-radius: 20px; 
            position: absolute; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%);
            display: flex; 
            align-items: center; 
            justify-content: center; 
            opacity: 0.7;
            animation: pulse 2s infinite;
        }

        /* Star Particles for Quiz */
        .star-particle {
            position: absolute;
            font-size: 1.5rem;
            color: gold;
            pointer-events: none;
            z-index: 1000;
            opacity: 0;
        }
        
        /* Bionic Arm Joint Indicators */
        .joint-indicator {
            position: absolute;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--accent-pink);
            border: 2px solid white;
            box-shadow: 0 0 10px var(--accent-pink);
            z-index: 200;
            pointer-events: none;
            display: none;
        }
    </style>
</head>
<body>

    <!-- Loading Screen -->
    <div id="loadingScreen">
        <div class="loader-ring"></div>
        <h2 style="margin-top: 30px; color: var(--accent-teal); letter-spacing: 3px; font-size: 1.5rem;">INITIALIZING BIONIC ARM LAB</h2>
        <div id="loadProgress" style="margin-top: 20px; width: 200px; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px;">
            <div style="width: 0%; height: 100%; background: var(--accent-teal); border-radius: 2px; transition: width 0.3s;"></div>
        </div>
    </div>

    <!-- Target Image Modal -->
    <div id="targetModal">
        <h3 style="color: white; margin-bottom: 20px; font-size: 1.5rem; text-transform: uppercase;">Scan this AR Marker</h3>
        <div class="target-image-display">
            <i class="fas fa-robot" style="font-size: 4rem; margin-bottom: 20px; color: white;"></i>
            <p style="font-weight: bold; font-size: 1.2rem; margin-bottom: 10px;">BIONIC ARM AR LAB</p>
            <p style="font-size: 0.9rem; margin-top: 10px;">Point camera at this marker or print it</p>
            <div style="margin-top: 20px; padding: 10px; background: white; border-radius: 8px;">
                <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=BionicArmARLab2.0" alt="QR Code" style="width: 150px; height: 150px;">
            </div>
        </div>
        <button class="btn-primary" onclick="document.getElementById('targetModal').style.display='none'">Close</button>
    </div>

    <!-- Start Screen -->
    <div id="startScreen" style="display: none;">
        <i class="fas fa-robot" style="font-size: 5rem; color: var(--accent-teal); margin-bottom: 20px;"></i>
        <h1 style="font-size: 3rem; text-align: center; line-height: 1.1; margin-bottom: 10px;">BIONIC ARM<br><span style="color: var(--accent-pink)">MECHATRONICS LAB</span></h1>
        <p style="max-width: 400px; text-align: center; margin-top: 20px; color: var(--text-muted); font-size: 1.1rem;">
            Advanced engineering simulation with real-time biomechanics, EMG signal analysis, and interactive prosthetic control.
        </p>
        <button class="btn-primary" id="btnStartAR">Initialize AR Mode</button>
        <button class="btn-text" onclick="document.getElementById('targetModal').style.display='flex'">View AR Marker</button>
        <button class="btn-secondary" id="btnStart3D">Desktop / Simulation Mode</button>
        
        <div id="mobileWarning" style="display: none; margin-top: 20px; padding: 15px; background: rgba(239, 68, 68, 0.15); border: 2px solid var(--accent-danger); border-radius: 12px; max-width: 350px;">
            <p style="color: var(--accent-danger); font-size: 0.9rem; margin: 0;">
                <i class="fas fa-exclamation-triangle"></i> Use Safari (iOS) or Chrome (Android). Grant Camera Permissions.
            </p>
        </div>
        
        <div style="margin-top: 40px; font-size: 0.9rem; color: var(--accent-teal); font-family: var(--font-code); border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px; width: 80%; text-align: center;">
            ADVANCED AR ENGINEERING LAB v3.0 | Mechatronics Simulation
        </div>
    </div>

    <!-- Main HUD -->
    <div id="mainHUD" class="hud-container" style="display: none;">
        <!-- Top Info -->
        <div class="top-bar">
            <div class="status-badge" id="sysStatus">
                <div class="status-dot"></div>
                <div class="tech-title">
                    <h1 id="statusText">System Active</h1>
                    <span id="modeIndicator">AR TRACKING</span>
                </div>
            </div>
            
            <div style="display: flex; gap: 12px;">
                <button class="icon-btn pointer-events-auto" id="btnQuiz" title="Knowledge Check" style="background: var(--glass-panel);">
                    <i class="fas fa-brain"></i>
                </button>
                <button class="icon-btn pointer-events-auto" id="btnGame" title="Gamification Task" style="background: var(--glass-panel);">
                    <i class="fas fa-gamepad"></i>
                </button>
                <button class="icon-btn pointer-events-auto" id="btnData" title="Live Data" style="background: var(--glass-panel);">
                    <i class="fas fa-chart-line"></i>
                </button>
                <button class="icon-btn pointer-events-auto" id="btnSettings" title="Arm Controls" style="background: var(--glass-panel);">
                    <i class="fas fa-sliders-h"></i>
                </button>
            </div>
        </div>
      
        <div id="starReward" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: none; z-index: 200; pointer-events: none;">
            <i class="fas fa-star" style="color: gold; font-size: 6rem; filter: drop-shadow(0 0 30px gold);"></i>
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-weight: bold; text-align: center;">
                <div style="font-size: 1.5rem; margin-top: 120px;">ACHIEVEMENT UNLOCKED!</div>
                <div style="font-size: 1rem; color: gold;" id="achievementText">Precision Control Expert</div>
            </div>
        </div>

        <!-- Control Panel (Left) -->
        <div class="side-panel control-room-panel" id="controlPanel">
            <div class="panel-header">
                <span class="panel-label">ARM CONTROL</span>
                <button class="close-btn" id="btnCloseControls">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="slider-group">
                <div class="slider-header">
                    <span class="slider-label">Shoulder Flexion</span>
                    <span class="slider-value" id="valShoulder">0°</span>
                </div>
                <input type="range" id="sliderShoulder" min="-90" max="90" value="0" step="1">
                <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 6px;">Range: -90° to 90° | Servo: MG996R</div>
            </div>

            <div class="slider-group">
                <div class="slider-header">
                    <span class="slider-label">Elbow Flexion</span>
                    <span class="slider-value" id="valElbow">0°</span>
                </div>
                <input type="range" id="sliderElbow" min="0" max="135" value="0" step="1">
                <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 6px;">Range: 0° to 135° | Torque: 15 kg·cm</div>
            </div>
            
            <div class="slider-group">
                <div class="slider-header">
                    <span class="slider-label">Wrist Rotation</span>
                    <span class="slider-value" id="valWrist">0°</span>
                </div>
                <input type="range" id="sliderWrist" min="-90" max="90" value="0" step="1">
                <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 6px;">Range: -90° to 90° | Precision: 0.1°</div>
            </div>
            
            <div class="slider-group">
                <div class="slider-header">
                    <span class="slider-label">Grip Strength</span>
                    <span class="slider-value" id="valGrip">0%</span>
                </div>
                <input type="range" id="sliderGrip" min="0" max="100" value="0" step="1">
                <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 6px;">Force: 0-20 kg | Tactile sensors: ON</div>
            </div>

            <div class="parameter-display">
                <div class="param-box">
                    <div class="param-label">EMG Signal</div>
                    <div class="param-value signal" id="valSignal">78%</div>
                </div>
                <div class="param-box">
                    <div class="param-label">Battery</div>
                    <div class="param-value battery" id="valBattery">92%</div>
                </div>
                <div class="param-box">
                    <div class="param-label">Torque Output</div>
                    <div class="param-value torque" id="valTorque">8.2 N·m</div>
                </div>
                <div class="param-box">
                    <div class="param-label">Power Draw</div>
                    <div class="param-value power" id="valPower">24W</div>
                </div>
            </div>
        </div>

        <!-- Game Panel (Left) -->
        <div class="side-panel game-panel" id="gamePanel">
            <div class="panel-header">
                <span class="panel-label">PRECISION CHALLENGE</span>
                <button class="close-btn" id="btnCloseGame">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="game-objective">
                <i class="fas fa-trophy"></i> GRAB & STACK CHALLENGE
            </div>
            
            <div class="game-instruction">
                Control the bionic arm to grab the floating objects and stack them in the target zone. Complete as many as possible in 60 seconds!
            </div>
            
            <div class="game-timer" id="gameTimer">60s</div>
            <div class="game-progress">
                <div class="game-progress-bar" id="gameProgressBar"></div>
            </div>
            <div class="game-score" id="gameScore">Score: 0</div>
            
            <div class="game-controls">
                <button class="game-btn" id="btnStartGame">
                    <i class="fas fa-play"></i> START CHALLENGE
                </button>
                <button class="game-btn" id="btnResetGame" disabled>
                    <i class="fas fa-redo"></i> RESTART
                </button>
                <div style="font-size: 0.8rem; color: var(--text-muted); text-align: center; margin-top: 10px;">
                    Use sliders to control the arm. Grab objects when they turn <span style="color: var(--accent-green);">green</span>.
                </div>
            </div>
        </div>

        <!-- Quiz Panel (Right) -->
        <div class="side-panel quiz-panel" id="quizPanel">
            <div class="panel-header">
                <span class="panel-label">KNOWLEDGE CHECK</span>
                <button class="close-btn" id="btnCloseQuiz">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div id="quizContent">
                <div class="quiz-question" id="qText">Question loading...</div>
                <div class="quiz-options" id="qOptions"></div>
                <button class="next-q-btn" id="btnNextQ">NEXT QUESTION <i class="fas fa-arrow-right" style="margin-left: 8px;"></i></button>
            </div>
            <div id="quizScore" style="margin-top: 20px; text-align: center; color: var(--accent-orange); font-weight: bold; font-size: 1.2rem;">Score: 0</div>
        </div>

        <!-- Data Panel -->
        <div class="side-panel data-panel" id="dataPanel">
            <div class="panel-header">
                <span class="panel-label">BIOMECHANICAL DATA</span>
                <button class="close-btn" id="btnCloseData">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="dataStreamContent" style="font-family: var(--font-code);">
                <!-- Data will be populated here -->
            </div>
        </div>

        <!-- Signal Visualization Popup -->
        <div class="signal-popup" id="signalPopup">
            <canvas id="signalCanvas" class="signal-canvas"></canvas>
            <div class="signal-label" id="signalLabel">EMG Signal Pattern</div>
            <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 5px; text-align: center;">
                Frequency: 100 Hz | Amplitude: 0-5 mV
            </div>
        </div>

        <!-- Center Guide (AR only) -->
        <div class="ar-target-guide" id="arGuide">
            <span style="color: white; font-size: 0.9rem; background: rgba(0,0,0,0.7); padding: 8px 16px; border-radius: 20px; font-weight: 600;">SCAN AR MARKER</span>
        </div>

        <!-- Bottom Controls -->
        <div class="bottom-dock">
            <div id="infoToast" style="background: var(--glass-panel); padding: 12px 24px; border-radius: 12px; border: 2px solid var(--accent-teal); display: none; margin-bottom: 10px; backdrop-filter: blur(20px); min-width: 200px; text-align: center;">
                <span id="toastText" style="font-weight: 600;">Component Selected</span>
                <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 4px;" id="toastSubtext">Click to interact</div>
            </div>

            <div class="mode-toggles">
                <button class="icon-btn pointer-events-auto" id="btnReset" title="Reset Arm"><i class="fas fa-sync-alt"></i></button>
                <button class="icon-btn pointer-events-auto" id="btnXray" title="X-Ray Mode"><i class="fas fa-layer-group"></i></button>
                <button class="icon-btn pointer-events-auto active" id="btnSignal" title="Signal Visualization"><i class="fas fa-wave-square"></i></button>
                <button class="icon-btn pointer-events-auto active" id="btnAudio" title="Audio Guide"><i class="fas fa-volume-up"></i></button>
                <button class="icon-btn pointer-events-auto" id="btnInfo" title="Component Info"><i class="fas fa-info-circle"></i></button>
                <button class="icon-btn pointer-events-auto" id="btnExit" title="Exit Lab" style="color: var(--accent-danger);"><i class="fas fa-power-off"></i></button>
            </div>
        </div>
        
        <!-- Game Objects (will be positioned dynamically) -->
        <div class="game-object" id="gameObject1" style="display: none; background: linear-gradient(135deg, #f59e0b, #d97706);">
            <i class="fas fa-cube"></i>
        </div>
        <div class="game-object" id="gameObject2" style="display: none; background: linear-gradient(135deg, #8b5cf6, #7c3aed);">
            <i class="fas fa-sphere"></i>
        </div>
        <div class="game-object" id="gameObject3" style="display: none; background: linear-gradient(135deg, #10b981, #059669);">
            <i class="fas fa-cube"></i>
        </div>
    </div>

    <!-- AR/3D Container -->
    <div id="container" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1;"></div>

    <script>
        // ==================== BIONIC ARM CONSTANTS ====================
        const COLORS = {
            carbon: 0x374151, darkMetal: 0x1f2937, servo: 0xdc2626,
            actuator: 0x3b82f6, sensor: 0x10b981, battery: 0xf59e0b,
            wiring: 0x6b7280, joint: 0x8b5cf6, grip: 0xec4899,
            highlight: 0x14b8a6
        };

        const BIOMECHANICAL_CONSTANTS = {
            maxShoulderTorque: 12, // N·m
            maxElbowTorque: 8, // N·m
            gripForce: 20, // kg
            batteryCapacity: 5000, // mAh
            signalFrequency: 100, // Hz
            emgAmplitude: 5 // mV
        };

        // ==================== ENHANCED QUIZ DATA ====================
        const quizQuestions = [
            { 
                q: "What does EMG stand for in bionic arm control?", 
                options: ["Electro-Muscular Graph", "Electromyography", "Electronic Motion Generator", "Electro-Mechanical Gear"], 
                correct: 1 
            },
            { 
                q: "Which type of motor is commonly used in prosthetic joints for precision control?", 
                options: ["DC Brushed Motor", "Stepper Motor", "Servo Motor", "AC Induction Motor"], 
                correct: 2 
            },
            { 
                q: "What is the primary function of a myoelectric sensor?", 
                options: ["Measure temperature", "Detect muscle electrical activity", "Measure joint angle", "Detect pressure"], 
                correct: 1 
            },
            { 
                q: "In mechatronics, what does 'DOF' stand for?", 
                options: ["Degree of Freedom", "Digital Output Frequency", "Direct Operational Force", "Dynamic Oscillation Factor"], 
                correct: 0 
            },
            { 
                q: "Which material is commonly used for bionic arm structural components?", 
                options: ["Steel", "Carbon Fiber", "Wood", "Aluminum"], 
                correct: 1 
            },
            { 
                q: "What is the purpose of a tendon-driven mechanism in prosthetic hands?", 
                options: ["Increase weight", "Reduce cost", "Allow natural finger movement", "Generate electricity"], 
                correct: 2 
            },
            { 
                q: "Which sensor type provides tactile feedback in bionic hands?", 
                options: ["Gyroscope", "Force-Sensitive Resistor", "Thermistor", "Photoresistor"], 
                correct: 1 
            },
            { 
                q: "What is 'pattern recognition' in myoelectric control?", 
                options: ["Identifying different muscle activation patterns", "Recognizing facial expressions", "Patterns in battery usage", "Signal noise filtering"], 
                correct: 0 
            },
            { 
                q: "Which joint typically has the highest range of motion in a bionic arm?", 
                options: ["Wrist", "Elbow", "Shoulder", "Finger"], 
                correct: 2 
            },
            { 
                q: "What does 'haptic feedback' provide to prosthetic users?", 
                options: ["Visual display", "Tactile sensation", "Audio signals", "Temperature reading"], 
                correct: 1 
            }
        ];

        // ==================== ENHANCED APP STATE ====================
        const state = {
            shoulderAngle: 0, elbowAngle: 0, wristAngle: 0, gripStrength: 0,
            emgSignal: 78, batteryLevel: 92, torqueOutput: 8.2, powerDraw: 24,
            isXray: false, signalActive: true, audioEnabled: true, dataStream: false,
            mode: 'AR', activeComponent: null, lastInteraction: Date.now(),
            startTime: 0, lastEmergency: 0, isEmergency: false, emergencyCount: 0,
            currentQ: 0, score: 0, achievements: [],
            isMobile: /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),
            audioContextInitialized: false,
            gameActive: false, gameScore: 0, gameTime: 60, gameObjects: [],
            gameInterval: null, totalStars: 0,
            armJoints: {
                shoulder: { angle: 0, min: -90, max: 90 },
                elbow: { angle: 0, min: 0, max: 135 },
                wrist: { angle: 0, min: -90, max: 90 },
                grip: { strength: 0, min: 0, max: 100 }
            }
        };

        // ==================== ENHANCED 3D ENGINE ====================
        let scene, camera, renderer, clock, mixer, mindarThree, rootGroup;
        let signalScene, signalCamera, signalRenderer;
        let audioCtx = null, ambientSound = null;
        let sirenInterval = null, toastTimer = null;
        let interactiveObjects = [];
        let armGroup, shoulderJoint, elbowJoint, wristJoint, handGroup;
        let gameObjects3D = [];

        // ==================== INITIALIZATION ====================
        window.addEventListener('load', () => {
            simulateLoading();
            
            if (state.isMobile) {
                document.getElementById('mobileWarning').style.display = 'block';
            }
            
            initAudioContext();
        });

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('btnStartAR').addEventListener('click', handleStartAR);
            document.getElementById('btnStart3D').addEventListener('click', () => startApp('3D'));
        });

        function simulateLoading() {
            let progress = 0;
            const progressBar = document.querySelector('#loadProgress div');
            const interval = setInterval(() => {
                progress += Math.random() * 10;
                if (progress > 100) {
                    progress = 100;
                    clearInterval(interval);
                    setTimeout(() => {
                        document.getElementById('loadingScreen').style.opacity = 0;
                        setTimeout(() => {
                            document.getElementById('loadingScreen').style.display = 'none';
                            document.getElementById('startScreen').style.display = 'flex';
                        }, 500);
                    }, 300);
                }
                progressBar.style.width = progress + '%';
            }, 100);
        }

        async function handleStartAR() {
            if (state.isMobile) {
                await requestCameraPermission();
            } else {
                await startApp('AR');
            }
        }

        async function requestCameraPermission() {
            try {
                if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                    alert('AR requires HTTPS for security.'); 
                    await startApp('3D');
                    return;
                }
                
                showToast("Camera access required for AR mode", "Please allow camera permissions when prompted");
                
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    } 
                });
                
                stream.getTracks().forEach(track => track.stop());
                
                initEnhancedAudio();
                
                await startApp('AR');
                
            } catch (error) {
                console.warn('Camera access denied:', error);
                showToast("Falling back to 3D mode", "Camera access was denied");
                await startApp('3D');
            }
        }

        function initAudioContext() {
            if (!audioCtx && state.audioEnabled) {
                try {
                    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                    audioCtx.suspend();
                    
                    const resumeAudio = () => {
                        if (audioCtx && audioCtx.state === 'suspended') {
                            audioCtx.resume();
                            document.removeEventListener('click', resumeAudio);
                            document.removeEventListener('touchstart', resumeAudio);
                        }
                    };
                    
                    document.addEventListener('click', resumeAudio, { once: true });
                    document.addEventListener('touchstart', resumeAudio, { once: true });
                    
                } catch (e) { 
                    console.log('Audio Context init error:', e); 
                }
            }
        }

        function initEnhancedAudio() {
            if (state.audioEnabled) {
                ambientSound = new Howl({
                    src: ['https://assets.mixkit.co/sfx/preview/mixkit-sci-fi-ambience-loop-365.mp3'],
                    volume: 0.05,
                    loop: true,
                    autoplay: true
                });
            }
        }

        async function startApp(mode) {
            state.mode = mode;
            state.startTime = Date.now();
            state.lastEmergency = Date.now();
            
            gsap.to(document.getElementById('startScreen'), {
                opacity: 0,
                duration: 0.5,
                onComplete: () => {
                    document.getElementById('startScreen').style.display = 'none';
                    document.getElementById('mainHUD').style.display = 'flex';
                    
                    gsap.from('.top-bar', { y: -50, opacity: 0, duration: 0.5 });
                    gsap.from('.bottom-dock', { y: 50, opacity: 0, duration: 0.5 });
                }
            });
            
            document.getElementById('modeIndicator').innerText = mode === 'AR' ? 'AR TRACKING ACTIVE' : 'SIMULATION MODE';
            
            if (mode === '3D') {
                document.getElementById('arGuide').style.display = 'none';
                initEnhanced3DMode();
            } else {
                document.body.classList.add('ar-active');
                await initEnhancedARMode();
            }
            
            initEnhancedUI();
            initQuiz();
            initSignalVisualization();
            startDataStream();
            animate();
        }

        // ==================== ENHANCED 3D SCENE ====================
        function createEnhancedScene() {
            scene = new THREE.Scene();
            
            scene.add(new THREE.AmbientLight(0xffffff, 0.6));
            
            const mainLight = new THREE.DirectionalLight(0xffffff, 1.2);
            mainLight.position.set(5, 15, 10);
            mainLight.castShadow = true;
            mainLight.shadow.mapSize.width = 2048;
            mainLight.shadow.mapSize.height = 2048;
            scene.add(mainLight);
            
            const fillLight = new THREE.HemisphereLight(0x14b8a6, 0x0f172a, 0.4);
            scene.add(fillLight);
            
            scene.fog = new THREE.FogExp2(0x0f172a, 0.02);
            
            rootGroup = new THREE.Group();
            scene.add(rootGroup);
            
            buildBionicArm();
        }

        function initEnhanced3DMode() {
            createEnhancedScene();
            scene.background = new THREE.Color(0x0f172a);
            
            const container = document.getElementById('container');
            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 1, 6);
            
            renderer = new THREE.WebGLRenderer({ 
                antialias: true, 
                alpha: true,
                powerPreference: "high-performance"
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.toneMappingExposure = 1.2;
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            
            container.appendChild(renderer.domElement);

            let isDragging = false, prev = {x: 0, y: 0};
            let zoomLevel = 1;
            
            container.addEventListener('mousedown', (e) => { 
                isDragging = true; 
                prev = {x: e.offsetX, y: e.offsetY}; 
            });
            
            window.addEventListener('mouseup', () => isDragging = false);
            
            container.addEventListener('mousemove', (e) => {
                if(isDragging) {
                    rootGroup.rotation.y += (e.offsetX - prev.x) * 0.005;
                    rootGroup.rotation.x = Math.max(-Math.PI/4, Math.min(Math.PI/4, 
                        rootGroup.rotation.x + (e.offsetY - prev.y) * 0.005));
                    prev = {x: e.offsetX, y: e.offsetY};
                }
            });
            
            container.addEventListener('wheel', (e) => {
                e.preventDefault();
                zoomLevel += e.deltaY * -0.001;
                zoomLevel = Math.min(Math.max(0.5, zoomLevel), 3);
                camera.position.z = 6 * zoomLevel;
            });
            
            container.addEventListener('touchstart', (e) => { 
                if(e.touches.length === 1) {
                    isDragging = true; 
                    prev = {x: e.touches[0].clientX, y: e.touches[0].clientY}; 
                }
            });
            
            container.addEventListener('touchend', () => isDragging = false);
            
            container.addEventListener('touchmove', (e) => {
                if(isDragging && e.touches.length === 1) {
                    e.preventDefault();
                    rootGroup.rotation.y += (e.touches[0].clientX - prev.x) * 0.01;
                    rootGroup.rotation.x += (e.touches[0].clientY - prev.y) * 0.01;
                    prev = {x: e.touches[0].clientX, y: e.touches[0].clientY};
                }
            });
            
            container.addEventListener('click', onEnhancedMouseClick);
        }

        async function initEnhancedARMode() {
            const container = document.getElementById('container');
            document.body.classList.add('ar-active');
            
            const targetSrc = "https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/examples/assets/image-templates/card-example/card.mind";
            
            try {
                const mindar = new window.MINDAR.IMAGE.MindARThree({
                    container: container,
                    imageTargetSrc: targetSrc,
                    uiLoading: "yes", 
                    uiScanning: "yes", 
                    uiError: "yes",
                    filterMinCF: 0.0001, 
                    filterBeta: 1000, 
                    maxTrack: 3,
                    warmupTolerance: 5,
                    missTolerance: 8
                });

                mindarThree = mindar;
                renderer = mindar.renderer; 
                scene = mindar.scene; 
                camera = mindar.camera;
                
                const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
                scene.add(ambientLight);
                
                const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
                directionalLight.position.set(0, 5, 5);
                scene.add(directionalLight);
                
                const pointLight = new THREE.PointLight(0x14b8a6, 0.5, 20);
                pointLight.position.set(0, 2, 2);
                scene.add(pointLight);

                const anchor = mindarThree.addAnchor(0);
                rootGroup = new THREE.Group();
                rootGroup.scale.set(0.3, 0.3, 0.3);
                anchor.group.add(rootGroup);

                buildBionicArm();
                
                mindarThree.onTargetFound = () => {
                    showToast("Target Found!", "AR tracking activated", 2000);
                    document.getElementById('arGuide').style.opacity = 0.3;
                };
                
                mindarThree.onTargetLost = () => {
                    document.getElementById('arGuide').style.opacity = 0.7;
                };
                
                await mindarThree.start();
                
            } catch (err) {
                console.error("AR initialization failed:", err);
                showToast("AR Failed - Switching to 3D", err.message, 3000);
                initEnhanced3DMode();
            }
        }

        // ==================== BIONIC ARM 3D MODEL ====================
        function getEnhancedMaterial(color, options = {}) {
            const defaults = {
                roughness: 0.3,
                metalness: 0.7,
                transparent: false,
                opacity: 1.0,
                emissive: 0x000000,
                emissiveIntensity: 0
            };
            
            const settings = {...defaults, ...options};
            
            return new THREE.MeshStandardMaterial({
                color: color,
                roughness: settings.roughness,
                metalness: settings.metalness,
                transparent: settings.transparent,
                opacity: settings.opacity,
                emissive: settings.emissive,
                emissiveIntensity: settings.emissiveIntensity,
                side: THREE.DoubleSide
            });
        }

        function buildBionicArm() {
            rootGroup.clear();
            interactiveObjects = [];
            gameObjects3D = [];
            
            armGroup = new THREE.Group();
            armGroup.name = "BionicArm";
            
            // Shoulder Assembly
            const shoulderGroup = new THREE.Group();
            shoulderGroup.name = "Shoulder";
            shoulderGroup.position.set(0, 0, 0);
            
            const shoulderHousing = new THREE.Mesh(
                new THREE.CylinderGeometry(0.8, 0.8, 1.2, 16),
                getEnhancedMaterial(COLORS.carbon, {emissive: 0x1f2937, emissiveIntensity: 0.1})
            );
            shoulderHousing.castShadow = true;
            shoulderGroup.add(shoulderHousing);
            
            const servoShoulder = new THREE.Mesh(
                new THREE.BoxGeometry(1, 1, 1),
                getEnhancedMaterial(COLORS.servo)
            );
            servoShoulder.position.set(0, 0.8, 0);
            servoShoulder.name = "ShoulderServo";
            shoulderGroup.add(servoShoulder);
            
            shoulderJoint = new THREE.Mesh(
                new THREE.SphereGeometry(0.5, 16, 16),
                getEnhancedMaterial(COLORS.joint)
            );
            shoulderJoint.position.set(0, 1.2, 0);
            shoulderJoint.name = "ShoulderJoint";
            shoulderGroup.add(shoulderJoint);
            
            armGroup.add(shoulderGroup);
            interactiveObjects.push(shoulderGroup);
            
            // Upper Arm
            const upperArmGroup = new THREE.Group();
            upperArmGroup.name = "UpperArm";
            upperArmGroup.position.set(0, 1.2, 0);
            
            const upperArm = new THREE.Mesh(
                new THREE.CylinderGeometry(0.4, 0.6, 2.5, 12),
                getEnhancedMaterial(COLORS.carbon)
            );
            upperArm.castShadow = true;
            upperArmGroup.add(upperArm);
            
            const wiringBundle = new THREE.Mesh(
                new THREE.CylinderGeometry(0.15, 0.15, 2.3, 8),
                getEnhancedMaterial(COLORS.wiring)
            );
            wiringBundle.position.set(0.3, 0, 0);
            upperArmGroup.add(wiringBundle);
            
            armGroup.add(upperArmGroup);
            
            // Elbow Assembly
            const elbowGroup = new THREE.Group();
            elbowGroup.name = "Elbow";
            elbowGroup.position.set(0, 2.5, 0);
            upperArmGroup.add(elbowGroup);
            
            const elbowJoint = new THREE.Mesh(
                new THREE.SphereGeometry(0.6, 16, 16),
                getEnhancedMaterial(COLORS.joint)
            );
            elbowJoint.name = "ElbowJoint";
            elbowGroup.add(elbowJoint);
            
            const elbowServo = new THREE.Mesh(
                new THREE.BoxGeometry(0.8, 0.8, 0.8),
                getEnhancedMaterial(COLORS.servo)
            );
            elbowServo.position.set(0.5, 0, 0);
            elbowServo.name = "ElbowServo";
            elbowGroup.add(elbowServo);
            
            interactiveObjects.push(elbowGroup);
            
            // Forearm
            const forearmGroup = new THREE.Group();
            forearmGroup.name = "Forearm";
            forearmGroup.position.set(0, 0, 0);
            elbowGroup.add(forearmGroup);
            
            const forearm = new THREE.Mesh(
                new THREE.CylinderGeometry(0.35, 0.45, 2.2, 12),
                getEnhancedMaterial(COLORS.carbon)
            );
            forearm.position.set(0, -1.1, 0);
            forearm.castShadow = true;
            forearmGroup.add(forearm);
            
            // Battery compartment
            const batteryCompartment = new THREE.Mesh(
                new THREE.BoxGeometry(0.8, 0.6, 0.4),
                getEnhancedMaterial(COLORS.battery)
            );
            batteryCompartment.position.set(0.4, -0.5, 0);
            batteryCompartment.name = "Battery";
            forearmGroup.add(batteryCompartment);
            
            // Wrist Assembly
            const wristGroup = new THREE.Group();
            wristGroup.name = "Wrist";
            wristGroup.position.set(0, -2.2, 0);
            forearmGroup.add(wristGroup);
            
            const wristJoint = new THREE.Mesh(
                new THREE.SphereGeometry(0.4, 16, 16),
                getEnhancedMaterial(COLORS.joint)
            );
            wristJoint.name = "WristJoint";
            wristGroup.add(wristJoint);
            
            const wristServo = new THREE.Mesh(
                new THREE.BoxGeometry(0.6, 0.6, 0.6),
                getEnhancedMaterial(COLORS.servo)
            );
            wristServo.position.set(0, 0, 0.4);
            wristServo.name = "WristServo";
            wristGroup.add(wristServo);
            
            interactiveObjects.push(wristGroup);
            
            // Hand Assembly
            handGroup = new THREE.Group();
            handGroup.name = "Hand";
            handGroup.position.set(0, 0, 0);
            wristGroup.add(handGroup);
            
            const palm = new THREE.Mesh(
                new THREE.BoxGeometry(1, 0.8, 0.4),
                getEnhancedMaterial(COLORS.carbon)
            );
            palm.position.set(0, 0, 0.2);
            palm.castShadow = true;
            handGroup.add(palm);
            
            // Create fingers
            const createFinger = (xOffset, length, isThumb = false) => {
                const fingerGroup = new THREE.Group();
                fingerGroup.position.set(xOffset, 0, 0.2);
                
                const segments = isThumb ? 2 : 3;
                const segmentLength = length / segments;
                
                for(let i = 0; i < segments; i++) {
                    const segment = new THREE.Mesh(
                        new THREE.BoxGeometry(0.15, segmentLength, 0.15),
                        getEnhancedMaterial(COLORS.carbon)
                    );
                    segment.position.set(0, -segmentLength * i - segmentLength/2, 0);
                    segment.castShadow = true;
                    fingerGroup.add(segment);
                    
                    if(i < segments - 1) {
                        const joint = new THREE.Mesh(
                            new THREE.SphereGeometry(0.08, 8, 8),
                            getEnhancedMaterial(COLORS.joint)
                        );
                        joint.position.set(0, -segmentLength * (i + 1), 0);
                        fingerGroup.add(joint);
                    }
                }
                
                // Add tactile sensor at tip
                const sensor = new THREE.Mesh(
                    new THREE.SphereGeometry(0.1, 8, 8),
                    getEnhancedMaterial(COLORS.sensor, {emissive: 0x10b981, emissiveIntensity: 0.3})
                );
                sensor.position.set(0, -length, 0);
                sensor.name = "TactileSensor";
                fingerGroup.add(sensor);
                
                return fingerGroup;
            };
            
            // Thumb
            const thumb = createFinger(-0.3, 0.8, true);
            thumb.rotation.z = Math.PI / 6;
            handGroup.add(thumb);
            
            // Fingers
            handGroup.add(createFinger(-0.15, 1.2));
            handGroup.add(createFinger(0, 1.3));
            handGroup.add(createFinger(0.15, 1.2));
            handGroup.add(createFinger(0.3, 1.0));
            
            // Grip actuators
            const gripActuator = new THREE.Mesh(
                new THREE.CylinderGeometry(0.2, 0.2, 0.6, 12),
                getEnhancedMaterial(COLORS.actuator)
            );
            gripActuator.position.set(0, -0.2, 0.5);
            gripActuator.name = "GripActuator";
            handGroup.add(gripActuator);
            
            interactiveObjects.push(handGroup);
            
            // EMG Sensors on arm
            const createEMGSensor = (position) => {
                const sensor = new THREE.Mesh(
                    new THREE.CylinderGeometry(0.1, 0.1, 0.05, 12),
                    getEnhancedMaterial(COLORS.sensor, {emissive: 0x10b981, emissiveIntensity: 0.5})
                );
                sensor.position.copy(position);
                sensor.name = "EMGSensor";
                return sensor;
            };
            
            upperArmGroup.add(createEMGSensor(new THREE.Vector3(0.3, 0.5, 0)));
            forearmGroup.add(createEMGSensor(new THREE.Vector3(0.3, -1, 0)));
            
            rootGroup.add(armGroup);
            
            // Create game objects for the gamification task
            createGameObjects3D();
        }

        function createGameObjects3D() {
            // Clear previous game objects
            gameObjects3D.forEach(obj => scene.remove(obj));
            gameObjects3D = [];
            
            // Create 3 floating objects to grab
            const colors = [0xf59e0b, 0x8b5cf6, 0x10b981];
            const shapes = ['cube', 'sphere', 'cylinder'];
            
            for(let i = 0; i < 3; i++) {
                let geometry;
                if(shapes[i] === 'cube') {
                    geometry = new THREE.BoxGeometry(0.4, 0.4, 0.4);
                } else if(shapes[i] === 'sphere') {
                    geometry = new THREE.SphereGeometry(0.3, 16, 16);
                } else {
                    geometry = new THREE.CylinderGeometry(0.2, 0.2, 0.5, 12);
                }
                
                const material = new THREE.MeshStandardMaterial({
                    color: colors[i],
                    roughness: 0.3,
                    metalness: 0.7,
                    emissive: colors[i],
                    emissiveIntensity: 0.2
                });
                
                const object = new THREE.Mesh(geometry, material);
                object.position.set(
                    (Math.random() - 0.5) * 3,
                    2 + Math.random() * 2,
                    (Math.random() - 0.5) * 3
                );
                object.castShadow = true;
                object.name = `GameObject${i+1}`;
                object.userData = {
                    type: 'gameObject',
                    collected: false,
                    index: i
                };
                
                scene.add(object);
                gameObjects3D.push(object);
            }
        }

        function updateArmPosition() {
            // Update shoulder rotation
            const shoulderGroup = armGroup.getObjectByName("Shoulder");
            if(shoulderGroup) {
                shoulderGroup.rotation.x = state.armJoints.shoulder.angle * Math.PI / 180;
            }
            
            // Update elbow rotation
            const upperArmGroup = armGroup.getObjectByName("UpperArm");
            if(upperArmGroup) {
                const elbowGroup = upperArmGroup.getObjectByName("Elbow");
                if(elbowGroup) {
                    elbowGroup.rotation.x = state.armJoints.elbow.angle * Math.PI / 180;
                }
            }
            
            // Update wrist rotation
            const forearmGroup = armGroup.getObjectByName("Forearm");
            if(forearmGroup) {
                const wristGroup = forearmGroup.getObjectByName("Wrist");
                if(wristGroup) {
                    wristGroup.rotation.x = state.armJoints.wrist.angle * Math.PI / 180;
                }
            }
            
            // Update finger positions based on grip strength
            const gripFactor = state.armJoints.grip.strength / 100;
            if(handGroup) {
                handGroup.children.forEach(child => {
                    if(child.type === "Group") { // Finger groups
                        child.rotation.x = -gripFactor * Math.PI / 6;
                    }
                });
            }
            
            // Update tactile sensor emission based on grip
            const sensors = scene.getObjectsByName("TactileSensor");
            sensors.forEach(sensor => {
                sensor.material.emissiveIntensity = 0.3 + gripFactor * 0.7;
            });
            
            // Update game object grabbing logic
            if(state.gameActive) {
                checkObjectGrabbing();
            }
        }

        function checkObjectGrabbing() {
            if(!handGroup || gameObjects3D.length === 0) return;
            
            const handPosition = new THREE.Vector3();
            handGroup.getWorldPosition(handPosition);
            
            gameObjects3D.forEach((obj, index) => {
                if(obj.userData.collected) return;
                
                const distance = handPosition.distanceTo(obj.position);
                const gripThreshold = 0.8 + (state.armJoints.grip.strength / 100) * 0.5;
                
                if(distance < gripThreshold && state.armJoints.grip.strength > 30) {
                    // Object grabbed!
                    obj.userData.collected = true;
                    state.gameScore += 10;
                    
                    // Visual feedback
                    obj.material.emissiveIntensity = 1;
                    obj.material.color.setHex(0x10b981);
                    
                    // Move object to stack position
                    gsap.to(obj.position, {
                        x: -2 + (index * 0.5),
                        y: 0.5 + (index * 0.4),
                        z: -2,
                        duration: 0.5,
                        ease: "power2.out"
                    });
                    
                    // Update game score
                    document.getElementById('gameScore').innerText = `Score: ${state.gameScore}`;
                    document.getElementById('gameProgressBar').style.width = `${Math.min(100, (state.gameScore / 30) * 100)}%`;
                    
                    // Play success sound
                    playSuccessSound();
                    
                    // Show toast
                    showToast("Object Grabbed!", "+10 points", 1000);
                    
                    // Check if all objects collected
                    const allCollected = gameObjects3D.every(obj => obj.userData.collected);
                    if(allCollected) {
                        endGame(true);
                    }
                }
            });
        }

        // ==================== ENHANCED UI LOGIC ====================
        function initEnhancedUI() {
            // Control panel toggle
            document.getElementById('btnSettings').onclick = () => {
                togglePanel('controlPanel');
                document.getElementById('quizPanel').classList.remove('active');
                document.getElementById('dataPanel').classList.remove('active');
                document.getElementById('gamePanel').classList.remove('active');
            };
            
            document.getElementById('btnCloseControls').addEventListener('click', function(e) {
                e.stopPropagation();
                document.getElementById('controlPanel').classList.remove('active');
            });
            
            // Game panel toggle
            document.getElementById('btnGame').onclick = () => {
                togglePanel('gamePanel');
                document.getElementById('controlPanel').classList.remove('active');
                document.getElementById('quizPanel').classList.remove('active');
                document.getElementById('dataPanel').classList.remove('active');
            };
            
            document.getElementById('btnCloseGame').addEventListener('click', function(e) {
                e.stopPropagation();
                document.getElementById('gamePanel').classList.remove('active');
            });
            
            // Quiz panel toggle
            document.getElementById('btnQuiz').onclick = () => {
                togglePanel('quizPanel');
                document.getElementById('controlPanel').classList.remove('active');
                document.getElementById('dataPanel').classList.remove('active');
                document.getElementById('gamePanel').classList.remove('active');
            };
            
            document.getElementById('btnCloseQuiz').addEventListener('click', function(e) {
                e.stopPropagation();
                document.getElementById('quizPanel').classList.remove('active');
            });
            
            // Data panel toggle
            document.getElementById('btnData').onclick = () => {
                togglePanel('dataPanel');
                document.getElementById('controlPanel').classList.remove('active');
                document.getElementById('quizPanel').classList.remove('active');
                document.getElementById('gamePanel').classList.remove('active');
            };
            
            document.getElementById('btnCloseData').addEventListener('click', function(e) {
                e.stopPropagation();
                document.getElementById('dataPanel').classList.remove('active');
            });
            
            // Enhanced slider controls for bionic arm
            const updateArmCalculations = () => {
                state.armJoints.shoulder.angle = parseInt(document.getElementById('sliderShoulder').value);
                state.armJoints.elbow.angle = parseInt(document.getElementById('sliderElbow').value);
                state.armJoints.wrist.angle = parseInt(document.getElementById('sliderWrist').value);
                state.armJoints.grip.strength = parseInt(document.getElementById('sliderGrip').value);
                
                document.getElementById('valShoulder').innerText = `${state.armJoints.shoulder.angle}°`;
                document.getElementById('valElbow').innerText = `${state.armJoints.elbow.angle}°`;
                document.getElementById('valWrist').innerText = `${state.armJoints.wrist.angle}°`;
                document.getElementById('valGrip').innerText = `${state.armJoints.grip.strength}%`;
                
                // Calculate biomechanical parameters
                const shoulderLoad = Math.abs(state.armJoints.shoulder.angle) / 90;
                const elbowLoad = state.armJoints.elbow.angle / 135;
                const gripLoad = state.armJoints.grip.strength / 100;
                
                // Torque calculation
                state.torqueOutput = 8.2 + shoulderLoad * 4 + elbowLoad * 2;
                document.getElementById('valTorque').innerText = `${state.torqueOutput.toFixed(1)} N·m`;
                
                // Power calculation
                state.powerDraw = 24 + shoulderLoad * 8 + elbowLoad * 4 + gripLoad * 6;
                document.getElementById('valPower').innerText = `${Math.round(state.powerDraw)}W`;
                
                // Battery drain simulation
                state.batteryLevel = Math.max(0, 92 - (state.powerDraw - 24) * 0.2);
                document.getElementById('valBattery').innerText = `${Math.round(state.batteryLevel)}%`;
                
                // EMG signal simulation
                const baseSignal = 78;
                const signalVariation = Math.sin(Date.now() * 0.01) * 10;
                const effortFactor = (shoulderLoad + elbowLoad + gripLoad) / 3 * 15;
                state.emgSignal = Math.max(0, Math.min(100, baseSignal + signalVariation + effortFactor));
                document.getElementById('valSignal').innerText = `${Math.round(state.emgSignal)}%`;
                
                // Update arm position in 3D
                updateArmPosition();
                
                // Check for emergency conditions
                checkForEmergency();
            };
            
            document.getElementById('sliderShoulder').oninput = updateArmCalculations;
            document.getElementById('sliderElbow').oninput = updateArmCalculations;
            document.getElementById('sliderWrist').oninput = updateArmCalculations;
            document.getElementById('sliderGrip').oninput = updateArmCalculations;
            
            // Initialize calculations
            updateArmCalculations();
            
            // Game controls
            document.getElementById('btnStartGame').onclick = startGame;
            document.getElementById('btnResetGame').onclick = resetGame;
            
            // Enhanced feature toggles
            document.getElementById('btnXray').onclick = (e) => {
                state.isXray = !state.isXray;
                e.currentTarget.classList.toggle('active');
                
                // Toggle transparency of arm components
                armGroup.traverse(child => {
                    if(child.material) {
                        if(child.name.includes("Servo") || child.name.includes("Joint") || 
                           child.name.includes("Sensor") || child.name.includes("Actuator")) {
                            child.material.transparent = state.isXray;
                            child.material.opacity = state.isXray ? 0.7 : 1.0;
                        } else if(child.material && !child.name.includes("GameObject")) {
                            child.material.transparent = state.isXray;
                            child.material.opacity = state.isXray ? 0.3 : 1.0;
                        }
                    }
                });
                
                showToast(state.isXray ? "X-Ray Mode ON" : "X-Ray Mode OFF", 
                         state.isXray ? "Viewing internal components" : "Normal view restored");
            };
            
            document.getElementById('btnSignal').onclick = (e) => { 
                state.signalActive = !state.signalActive; 
                e.currentTarget.classList.toggle('active');
                
                if(state.signalActive) {
                    document.getElementById('signalPopup').style.display = 'flex';
                } else {
                    document.getElementById('signalPopup').style.display = 'none';
                }
                
                showToast(state.signalActive ? "Signal Visualization ON" : "Signal Visualization OFF");
            };
            
            document.getElementById('btnReset').onclick = () => { 
                // Reset arm to neutral position
                document.getElementById('sliderShoulder').value = 0;
                document.getElementById('sliderElbow').value = 0;
                document.getElementById('sliderWrist').value = 0;
                document.getElementById('sliderGrip').value = 0;
                updateArmCalculations();
                
                if(rootGroup) {
                    gsap.to(rootGroup.rotation, {x: 0, y: 0, z: 0, duration: 1});
                }
                showToast("Arm Reset", "All joints returned to neutral position");
            };
            
            document.getElementById('btnInfo').onclick = () => {
                showToast("Component Information", "Click on any arm component to learn more");
            };
            
            document.getElementById('btnExit').onclick = () => {
                if(confirm("Exit the Bionic Arm Lab?")) {
                    location.reload();
                }
            };
            
            // Audio toggle
            document.getElementById('btnAudio').onclick = (e) => {
                state.audioEnabled = !state.audioEnabled;
                e.currentTarget.classList.toggle('active');
                
                if(state.audioEnabled) {
                    if(audioCtx && audioCtx.state === 'suspended') {
                        audioCtx.resume();
                    }
                    if(ambientSound) {
                        ambientSound.play();
                    }
                    showToast("Audio Enabled", "Sound effects and voice guide ON");
                } else {
                    if(ambientSound) {
                        ambientSound.pause();
                    }
                    window.speechSynthesis.cancel();
                    showToast("Audio Disabled", "All sounds muted");
                }
            };
        }

        function togglePanel(panelId) {
            const panel = document.getElementById(panelId);
            const isActive = panel.classList.contains('active');
            
            document.querySelectorAll('.side-panel').forEach(p => {
                p.classList.remove('active');
            });
            
            if(!isActive) {
                panel.classList.add('active');
                gsap.fromTo(panel, 
                    {x: panelId === 'controlPanel' || panelId === 'gamePanel' ? -50 : 50, opacity: 0}, 
                    {x: 0, opacity: 1, duration: 0.3}
                );
            }
        }

        function checkForEmergency() {
            const torqueOk = state.torqueOutput <= 15;
            const batteryOk = state.batteryLevel >= 15;
            const signalOk = state.emgSignal >= 20;
            
            if(!torqueOk || !batteryOk || !signalOk) {
                if(!state.isEmergency) {
                    triggerEmergency();
                }
            } else if(state.isEmergency) {
                resolveEmergency();
            }
        }

        // ==================== GAMIFICATION SYSTEM ====================
        function startGame() {
            if(state.gameActive) return;
            
            state.gameActive = true;
            state.gameScore = 0;
            state.gameTime = 60;
            
            document.getElementById('btnStartGame').disabled = true;
            document.getElementById('btnResetGame').disabled = false;
            document.getElementById('gameScore').innerText = `Score: 0`;
            document.getElementById('gameProgressBar').style.width = `0%`;
            
            // Reset game objects
            gameObjects3D.forEach(obj => {
                obj.userData.collected = false;
                obj.material.emissiveIntensity = 0.2;
                obj.position.set(
                    (Math.random() - 0.5) * 3,
                    2 + Math.random() * 2,
                    (Math.random() - 0.5) * 3
                );
                scene.add(obj);
            });
            
            // Show UI game objects
            for(let i = 1; i <= 3; i++) {
                const obj = document.getElementById(`gameObject${i}`);
                if(obj) {
                    obj.style.display = 'flex';
                    const x = 50 + Math.random() * 70;
                    const y = 30 + Math.random() * 40;
                    obj.style.left = `${x}%`;
                    obj.style.top = `${y}%`;
                    obj.style.animation = `float 3s infinite ease-in-out`;
                    obj.style.animationDelay = `${i * 0.5}s`;
                }
            }
            
            // Start game timer
            const timerElement = document.getElementById('gameTimer');
            state.gameInterval = setInterval(() => {
                state.gameTime--;
                timerElement.innerText = `${state.gameTime}s`;
                
                if(state.gameTime <= 0) {
                    endGame(false);
                }
                
                // Make objects float
                gameObjects3D.forEach(obj => {
                    if(!obj.userData.collected) {
                        obj.position.y = 2 + Math.sin(Date.now() * 0.002 + obj.userData.index) * 0.5;
                    }
                });
            }, 1000);
            
            showToast("Game Started!", "Grab all objects before time runs out!", 2000);
        }

        function endGame(success) {
            if(!state.gameActive) return;
            
            state.gameActive = false;
            clearInterval(state.gameInterval);
            
            document.getElementById('btnStartGame').disabled = false;
            
            // Hide UI game objects
            for(let i = 1; i <= 3; i++) {
                const obj = document.getElementById(`gameObject${i}`);
                if(obj) obj.style.display = 'none';
            }
            
            if(success) {
                showToast("Challenge Complete!", `Final Score: ${state.gameScore}`, 3000);
                showStarReward("Precision Master!", "Perfect object collection");
                state.totalStars += 3;
                
                // Add achievement
                if(!state.achievements.includes("game_complete")) {
                    state.achievements.push("game_complete");
                    addDataStreamEntry("ACHIEVEMENT", "Precision Challenge Master - Collected all objects");
                }
            } else {
                showToast("Time's Up!", `Final Score: ${state.gameScore}`, 3000);
                if(state.gameScore >= 20) {
                    showStarReward("Good Effort!", "Partial completion bonus");
                    state.totalStars += 1;
                }
            }
            
            // Update quiz score display with stars
            document.getElementById('quizScore').innerHTML = `
                Score: <span style="color: var(--accent-orange);">${state.score}</span> |
                Stars: <span style="color: gold;">${state.totalStars}</span>
            `;
        }

        function resetGame() {
            endGame(false);
            startGame();
        }

        // ==================== EMERGENCY SYSTEM ====================
        function triggerEmergency() {
            if(state.isEmergency) return;
            
            state.isEmergency = true;
            state.emergencyCount++;
            
            document.body.classList.add('critical-state');
            document.getElementById('statusText').innerText = "SYSTEM OVERLOAD";
            document.getElementById('statusText').style.animation = "flash 0.5s infinite";
            
            if(state.audioEnabled) {
                window.speechSynthesis.cancel();
                speak(`Emergency! System overload detected. Torque: ${state.torqueOutput.toFixed(1)} Newton meters. Battery: ${Math.round(state.batteryLevel)} percent.`);
                startSiren();
            }
            
            document.querySelectorAll('.param-value').forEach(el => {
                el.style.color = 'var(--accent-pink)';
            });
            
            document.getElementById('controlPanel').classList.add('active');
            
            addDataStreamEntry("EMERGENCY", `System overload: Torque=${state.torqueOutput.toFixed(1)}N·m, Battery=${Math.round(state.batteryLevel)}%`);
            
            showToast("EMERGENCY!", "Adjust parameters to stabilize system", 0);
        }

        function resolveEmergency() {
            if(!state.isEmergency) return;
            
            state.isEmergency = false;
            state.lastEmergency = Date.now();
            
            document.body.classList.remove('critical-state');
            document.getElementById('statusText').innerText = "System Active";
            document.getElementById('statusText').style.animation = "";
            
            stopSiren();
            
            if(state.audioEnabled) {
                window.speechSynthesis.cancel();
                speak("System stabilized. All parameters within safe range.");
            }
            
            updateArmCalculations();
            
            showStarReward("System Stabilized!", "Emergency Response Expert");
            state.totalStars += 1;
            
            addDataStreamEntry("SYSTEM", "Emergency resolved - parameters stabilized");
            
            setTimeout(() => {
                const toast = document.getElementById('infoToast');
                gsap.to(toast, {
                    opacity: 0,
                    y: 20,
                    duration: 0.3,
                    onComplete: () => {
                        toast.style.display = 'none';
                    }
                });
            }, 2000);
            
            setTimeout(() => {
                document.getElementById('controlPanel').classList.remove('active');
            }, 3000);
        }

        function startSiren() {
            if(sirenInterval) clearInterval(sirenInterval);
            
            let sirenPhase = 0;
            sirenInterval = setInterval(() => {
                if(!state.isEmergency) {
                    clearInterval(sirenInterval);
                    return;
                }
                
                if(audioCtx && state.audioEnabled) {
                    try {
                        const oscillator = audioCtx.createOscillator();
                        const gainNode = audioCtx.createGain();
                        
                        oscillator.connect(gainNode);
                        gainNode.connect(audioCtx.destination);
                        
                        oscillator.frequency.setValueAtTime(
                            sirenPhase % 2 === 0 ? 880 : 440,
                            audioCtx.currentTime
                        );
                        
                        gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.8);
                        
                        oscillator.start();
                        oscillator.stop(audioCtx.currentTime + 0.8);
                        
                        sirenPhase++;
                    } catch(e) {
                        console.log("Siren audio error:", e);
                    }
                }
            }, 1000);
        }

        function stopSiren() {
            if(sirenInterval) {
                clearInterval(sirenInterval);
                sirenInterval = null;
            }
        }

        function showStarReward(title, subtitle) {
            const starContainer = document.getElementById('starReward');
            const achievementText = document.getElementById('achievementText');
            
            achievementText.innerText = subtitle;
            
            starContainer.style.display = 'block';
            starContainer.style.opacity = '0';
            
            gsap.to(starContainer, {
                opacity: 1,
                duration: 0.5,
                onComplete: () => {
                    setTimeout(() => {
                        gsap.to(starContainer, {
                            opacity: 0,
                            duration: 0.5,
                            delay: 1.5,
                            onComplete: () => {
                                starContainer.style.display = 'none';
                            }
                        });
                    }, 1000);
                }
            });
        }

        // ==================== ENHANCED QUIZ SYSTEM ====================
        function initQuiz() {
            const renderQuestion = () => {
                const q = quizQuestions[state.currentQ];
                document.getElementById('qText').innerHTML = `
                    <strong>Q${state.currentQ + 1}/${quizQuestions.length}:</strong> ${q.q}
                    <div style="margin-top: 10px; font-size: 0.85rem; color: var(--text-muted);">
                        Bionics | Mechatronics | Engineering Terminology
                    </div>
                `;
                
                const optionsDiv = document.getElementById('qOptions');
                optionsDiv.innerHTML = '';
                
                document.getElementById('btnNextQ').style.display = 'none';
                
                q.options.forEach((opt, i) => {
                    const btn = document.createElement('div');
                    btn.className = 'quiz-btn';
                    btn.innerHTML = `<span style="margin-right: 10px; opacity: 0.7;">${String.fromCharCode(65 + i)}.</span> ${opt}`;
                    
                    btn.onclick = () => handleAnswer(i, q.correct, btn);
                    optionsDiv.appendChild(btn);
                });
            };
            
            renderQuestion();
            
            document.getElementById('btnNextQ').onclick = () => {
                state.currentQ = (state.currentQ + 1) % quizQuestions.length;
                renderQuestion();
                
                document.getElementById('quizScore').innerHTML = `
                    Score: <span style="color: var(--accent-orange);">${state.score}</span> |
                    Progress: ${state.currentQ + 1}/${quizQuestions.length} |
                    Stars: <span style="color: gold;">${state.totalStars}</span>
                `;
            };
        }

        function handleAnswer(selected, correct, button) {
            const options = button.parentElement.children;
            
            Array.from(options).forEach(btn => {
                btn.style.pointerEvents = 'none';
            });
            
            if(selected === correct) {
                button.classList.add('correct');
                state.score += 10;
                
                showQuizStarParticles(button);
                state.totalStars += 1;
                
                if(state.audioEnabled) {
                    playSuccessSound();
                }
                
                if(state.score >= 50 && !state.achievements.includes("quiz_master")) {
                    state.achievements.push("quiz_master");
                    addDataStreamEntry("ACHIEVEMENT", "Quiz Master - Scored 50+ points in knowledge check");
                    showStarReward("Quiz Master!", "Scored 50+ points");
                }
            } else {
                button.classList.add('wrong');
                options[correct].classList.add('correct');
                
                if(state.audioEnabled) {
                    playErrorSound();
                }
            }
            
            document.getElementById('btnNextQ').style.display = 'block';
            
            document.getElementById('quizScore').innerHTML = `
                Score: <span style="color: var(--accent-orange);">${state.score}</span> |
                Progress: ${state.currentQ + 1}/${quizQuestions.length} |
                Stars: <span style="color: gold;">${state.totalStars}</span>
            `;
        }

        function showQuizStarParticles(button) {
            const rect = button.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            
            for(let i = 0; i < 5; i++) {
                const star = document.createElement('div');
                star.className = 'star-particle';
                star.innerHTML = '<i class="fas fa-star"></i>';
                star.style.position = 'fixed';
                star.style.left = centerX + 'px';
                star.style.top = centerY + 'px';
                star.style.color = 'gold';
                star.style.fontSize = (1 + Math.random() * 0.5) + 'rem';
                star.style.opacity = '0';
                star.style.zIndex = '1000';
                star.style.pointerEvents = 'none';
                
                document.body.appendChild(star);
                
                gsap.to(star, {
                    duration: 1 + Math.random() * 0.5,
                    x: (Math.random() - 0.5) * 200,
                    y: (Math.random() - 0.5) * 200 - 100,
                    opacity: 1,
                    scale: 0,
                    ease: "power2.out",
                    onComplete: () => {
                        document.body.removeChild(star);
                    }
                });
            }
        }

        // ==================== SIGNAL VISUALIZATION ====================
        function initSignalVisualization() {
            const canvas = document.getElementById('signalCanvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = canvas.clientWidth;
            canvas.height = canvas.clientHeight;
            
            let signalData = [];
            for(let i = 0; i < 100; i++) {
                signalData.push(Math.random() * 50 + 25);
            }
            
            function drawSignal() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Draw grid
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
                ctx.lineWidth = 1;
                
                // Vertical lines
                for(let i = 0; i <= 10; i++) {
                    ctx.beginPath();
                    ctx.moveTo(i * canvas.width / 10, 0);
                    ctx.lineTo(i * canvas.width / 10, canvas.height);
                    ctx.stroke();
                }
                
                // Horizontal lines
                for(let i = 0; i <= 5; i++) {
                    ctx.beginPath();
                    ctx.moveTo(0, i * canvas.height / 5);
                    ctx.lineTo(canvas.width, i * canvas.height / 5);
                    ctx.stroke();
                }
                
                // Draw signal
                ctx.beginPath();
                ctx.strokeStyle = '#10b981';
                ctx.lineWidth = 2;
                ctx.lineJoin = 'round';
                
                const time = Date.now() * 0.01;
                
                for(let i = 0; i < signalData.length; i++) {
                    const x = i * canvas.width / (signalData.length - 1);
                    const baseValue = signalData[i];
                    const variation = Math.sin(time * 0.05 + i * 0.3) * 10;
                    const amplitude = (state.emgSignal / 100) * 30;
                    const y = canvas.height - ((baseValue + variation) * amplitude / 100);
                    
                    if(i === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                }
                
                ctx.stroke();
                
                // Update signal data
                signalData.shift();
                const newValue = 25 + Math.sin(time * 0.1) * 15 + (state.emgSignal / 100) * 10;
                signalData.push(newValue);
                
                requestAnimationFrame(drawSignal);
            }
            
            drawSignal();
        }

        // ==================== INTERACTION SYSTEM ====================
        function onEnhancedMouseClick(e) {
            const mouse = new THREE.Vector2();
            const rect = renderer.domElement.getBoundingClientRect();
            
            if(e.type === 'click') {
                mouse.x = ((e.clientX - rect.left) / rect.width) * 2 - 1;
                mouse.y = -((e.clientY - rect.top) / rect.height) * 2 + 1;
            } else if(e.type === 'touchstart') {
                mouse.x = ((e.touches[0].clientX - rect.left) / rect.width) * 2 - 1;
                mouse.y = -((e.touches[0].clientY - rect.top) / rect.height) * 2 + 1;
            }
            
            const raycaster = new THREE.Raycaster();
            raycaster.setFromCamera(mouse, camera);
            
            const interactiveHits = raycaster.intersectObjects(interactiveObjects, true);
            if(interactiveHits.length > 0) {
                const object = interactiveHits[0].object;
                let parent = object;
                
                while(parent.parent && !interactiveObjects.includes(parent)) {
                    parent = parent.parent;
                }
                
                if(parent.name) {
                    selectComponent(parent.name, parent.userData);
                    return;
                }
            }
            
            const hits = raycaster.intersectObjects(rootGroup.children, true);
            if(hits.length > 0) {
                let object = hits[0].object;
                
                while(object.parent && object.parent !== rootGroup && !object.name) {
                    object = object.parent;
                }
                
                if(object.name) {
                    selectComponent(object.name, object.userData || {});
                }
            }
        }

        function selectComponent(name, data = {}) {
            state.activeComponent = name;
            state.lastInteraction = Date.now();
            
            const toast = document.getElementById('infoToast');
            const toastText = document.getElementById('toastText');
            const toastSubtext = document.getElementById('toastSubtext');
            
            const componentInfo = {
                "Shoulder": {
                    title: "SHOULDER JOINT",
                    desc: "3-DOF spherical joint with MG996R servo",
                    info: "Provides flexion/extension, abduction/adduction, and rotation. Maximum torque: 12 N·m."
                },
                "Elbow": {
                    title: "ELBOW JOINT",
                    desc: "1-DOF hinge joint with position feedback",
                    info: "Provides 0-135° flexion. Equipped with potentiometer for position sensing."
                },
                "Wrist": {
                    title: "WRIST JOINT",
                    desc: "2-DOF joint with precision servo",
                    info: "Allows flexion/extension and rotation. Precision: ±0.1° with encoder feedback."
                },
                "Hand": {
                    title: "MYOELECTRIC HAND",
                    desc: "5-finger anthropomorphic design",
                    info: "Independently controlled fingers with tactile sensors. Grip force: 0-20 kg."
                },
                "ShoulderServo": {
                    title: "SHOULDER SERVO",
                    desc: "High-torque digital servo",
                    info: "MG996R metal-gear servo. Torque: 12 kg·cm at 6V. Speed: 0.17s/60°."
                },
                "ElbowServo": {
                    title: "ELBOW SERVO",
                    desc: "Feedback servo with encoder",
                    info: "Equipped with magnetic encoder for precise position control. IP54 rated."
                },
                "WristServo": {
                    title: "WRIST SERVO",
                    desc: "Micro digital servo",
                    info: "Compact size with metal gears. Provides smooth rotation control."
                },
                "Battery": {
                    title: "LITHIUM-ION BATTERY",
                    desc: "High-capacity power source",
                    info: "5000mAh, 14.8V. Provides 8-12 hours of continuous operation."
                },
                "EMGSensor": {
                    title: "EMG SENSOR",
                    desc: "Surface electromyography electrode",
                    info: "Detects muscle electrical activity. Sampling rate: 1000 Hz. Resolution: 10-bit."
                },
                "TactileSensor": {
                    title: "TACTILE SENSOR",
                    desc: "Force-sensitive resistor array",
                    info: "Provides grip force feedback. Range: 0-20 N. Resolution: 0.1 N."
                },
                "GripActuator": {
                    title: "GRIP ACTUATOR",
                    desc: "Linear actuator for finger control",
                    info: "Provides smooth finger movement. Stroke: 20mm. Force: 50N."
                }
            };
            
            const info = componentInfo[name] || {
                title: name.toUpperCase(),
                desc: "Bionic Arm Component",
                info: "Click components to learn about bionic arm mechatronics"
            };
            
            toastText.innerText = info.title;
            toastSubtext.innerText = info.desc;
            
            toast.style.display = 'block';
            gsap.killTweensOf(toast);
            gsap.fromTo(toast, 
                { opacity: 0, y: 20 }, 
                { opacity: 1, y: 0, duration: 0.3 }
            );
            
            if(toastTimer) clearTimeout(toastTimer);
            toastTimer = setTimeout(() => {
                gsap.to(toast, {
                    opacity: 0,
                    y: 20,
                    duration: 0.3,
                    onComplete: () => {
                        toast.style.display = 'none';
                    }
                });
            }, 3000);
            
            if(state.audioEnabled && !state.isEmergency) {
                speak(info.title + ". " + info.info);
            }
            
            addDataStreamEntry("INTERACTION", `Selected: ${name}`);
        }

        // ==================== DATA STREAM SYSTEM ====================
        function startDataStream() {
            addDataStreamEntry("SYSTEM", "Bionic Arm Engineering Lab initialized");
            addDataStreamEntry("PARAMETERS", `Initial: Shoulder=0°, Elbow=0°, Grip=0%`);
            
            setInterval(() => {
                if(!document.getElementById('dataPanel').classList.contains('active')) return;
                
                const now = new Date();
                const timeStr = now.toLocaleTimeString('en-US', {hour12: false});
                
                const dataTypes = [
                    `[${timeStr}] EMG Signal Strength: ${state.emgSignal.toFixed(1)}%`,
                    `[${timeStr}] Power Consumption: ${state.powerDraw.toFixed(1)}W`,
                    `[${timeStr}] System Temperature: ${(35 + Math.random() * 5).toFixed(1)}°C`,
                    `[${timeStr}] Data Rate: 1000 packets/sec`,
                    `[${timeStr}] Control Loop: ${(5 + Math.random() * 2).toFixed(1)}ms`
                ];
                
                addDataStreamEntry("DATA", dataTypes[Math.floor(Math.random() * dataTypes.length)]);
            }, 5000);
        }

        function addDataStreamEntry(type, message) {
            const contentDiv = document.getElementById('dataStreamContent');
            const entry = document.createElement('div');
            
            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-US', {hour12: false});
            
            let typeClass = "";
            switch(type) {
                case "EMERGENCY": typeClass = "color: var(--accent-pink);"; break;
                case "ACHIEVEMENT": typeClass = "color: gold;"; break;
                case "SYSTEM": typeClass = "color: var(--accent-teal);"; break;
                case "INTERACTION": typeClass = "color: var(--accent-green);"; break;
                default: typeClass = "color: var(--text-muted);";
            }
            
            entry.innerHTML = `
                <div style="margin-bottom: 8px; padding: 8px; background: rgba(255,255,255,0.05); border-radius: 6px; border-left: 3px solid ${typeClass.split(':')[1].trim().replace(';','')}">
                    <div style="font-size: 0.75rem; ${typeClass} margin-bottom: 2px;">
                        ${type} • ${timeStr}
                    </div>
                    <div style="font-size: 0.85rem;">
                        ${message}
                    </div>
                </div>
            `;
            
            contentDiv.insertBefore(entry, contentDiv.firstChild);
            
            if(contentDiv.children.length > 20) {
                contentDiv.removeChild(contentDiv.lastChild);
            }
        }

        // ==================== UTILITY FUNCTIONS ====================
        function speak(text) {
            if(state.audioEnabled && 'speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = 0.9;
                utterance.pitch = 1;
                utterance.volume = 1;
                
                const voices = window.speechSynthesis.getVoices();
                const preferredVoice = voices.find(v => v.name.includes('Google') && v.lang.includes('en')) ||
                                     voices.find(v => v.lang.includes('en'));
                
                if(preferredVoice) {
                    utterance.voice = preferredVoice;
                }
                
                window.speechSynthesis.speak(utterance);
            }
        }

        function showToast(title, subtitle = "", duration = 2000) {
            const toast = document.getElementById('infoToast');
            const toastText = document.getElementById('toastText');
            const toastSubtext = document.getElementById('toastSubtext');
            
            toastText.innerText = title;
            toastSubtext.innerText = subtitle;
            
            toast.style.display = 'block';
            gsap.killTweensOf(toast);
            gsap.fromTo(toast, 
                { opacity: 0, y: 20 }, 
                { opacity: 1, y: 0, duration: 0.3 }
            );
            
            if(toastTimer) clearTimeout(toastTimer);
            toastTimer = setTimeout(() => {
                gsap.to(toast, {
                    opacity: 0,
                    y: 20,
                    duration: 0.3,
                    onComplete: () => {
                        toast.style.display = 'none';
                    }
                });
            }, duration);
        }

        function playSuccessSound() {
            if(audioCtx && state.audioEnabled) {
                try {
                    const oscillator = audioCtx.createOscillator();
                    const gainNode = audioCtx.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioCtx.destination);
                    
                    oscillator.frequency.setValueAtTime(523.25, audioCtx.currentTime);
                    oscillator.frequency.setValueAtTime(659.25, audioCtx.currentTime + 0.1);
                    oscillator.frequency.setValueAtTime(783.99, audioCtx.currentTime + 0.2);
                    
                    gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.5);
                    
                    oscillator.start();
                    oscillator.stop(audioCtx.currentTime + 0.5);
                } catch(e) {
                    console.log("Success sound error:", e);
                }
            }
        }

        function playErrorSound() {
            if(audioCtx && state.audioEnabled) {
                try {
                    const oscillator = audioCtx.createOscillator();
                    const gainNode = audioCtx.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioCtx.destination);
                    
                    oscillator.frequency.setValueAtTime(349.23, audioCtx.currentTime);
                    oscillator.frequency.setValueAtTime(293.66, audioCtx.currentTime + 0.1);
                    
                    gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.3);
                    
                    oscillator.start();
                    oscillator.stop(audioCtx.currentTime + 0.3);
                } catch(e) {
                    console.log("Error sound error:", e);
                }
            }
        }

        // ==================== ANIMATION LOOP ====================
        function animate() {
            requestAnimationFrame(animate);
            
            const time = Date.now() * 0.001;
            
            // Animate game objects if game is active
            if(state.gameActive && gameObjects3D.length > 0) {
                gameObjects3D.forEach((obj, index) => {
                    if(!obj.userData.collected) {
                        obj.rotation.y += 0.01;
                        obj.rotation.x = Math.sin(time * 0.5 + index) * 0.1;
                    }
                });
            }
            
            // Auto-emergency check
            if(!state.isEmergency && Date.now() - state.lastEmergency > 45000 + Math.random() * 30000) {
                triggerEmergency();
            }
            
            // Render main scene
            if(renderer && scene && camera) {
                renderer.render(scene, camera);
            }
        }

        // ==================== WINDOW RESIZE HANDLER ====================
        window.addEventListener('resize', () => {
            if(camera) {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
            }
            
            if(renderer) {
                renderer.setSize(window.innerWidth, window.innerHeight);
            }
            
            const signalCanvas = document.getElementById('signalCanvas');
            if(signalCanvas) {
                signalCanvas.width = signalCanvas.clientWidth;
                signalCanvas.height = signalCanvas.clientHeight;
            }
        });

        // ==================== START THE APPLICATION ====================
        if ('speechSynthesis' in window) {
            window.speechSynthesis.getVoices();
        }
    </script>
</body>
</html>
